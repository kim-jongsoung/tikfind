<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikFind - Live Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-slate-900">
    <div id="sidebar-container"></div>
    <div id="header-container"></div>
    
    <main class="ml-0 md:ml-64 mt-16 p-4 md:p-8">
        <div class="max-w-7xl mx-auto">
            <!-- í—¤ë” & ë¼ì´ë¸Œ ì‹œì‘ ë²„íŠ¼ -->
            <div class="mb-6 flex justify-between items-center">
                <div>
                    <h2 class="text-3xl font-bold text-white">ğŸ¥ Live Dashboard</h2>
                    <p class="text-gray-400 mt-2">ì‹¤ì‹œê°„ TikTok Live ë°©ì†¡ ê´€ë¦¬</p>
                </div>
                <button id="startLiveBtn" class="px-6 py-3 bg-gradient-to-r from-pink-500 to-purple-600 text-white font-bold rounded-lg hover:shadow-xl transition transform hover:scale-105">
                    <i class="fas fa-rocket mr-2"></i>ë¼ì´ë¸Œ ì‹œì‘
                </button>
            </div>

            <!-- Desktop App ìƒíƒœ -->
            <div id="appStatus" class="mb-6 p-4 bg-slate-800 rounded-lg border-l-4 border-yellow-500">
                <div class="flex items-center justify-between">
                    <div class="flex items-center">
                        <i class="fas fa-desktop text-yellow-400 text-2xl mr-3"></i>
                        <div>
                            <p class="text-white font-semibold">Desktop App ìƒíƒœ</p>
                            <p id="appStatusText" class="text-sm text-gray-400">í™•ì¸ ì¤‘...</p>
                            <p class="text-xs text-gray-500 mt-1">User ID: <span id="userIdDisplay" class="font-mono">ë¡œë”© ì¤‘...</span></p>
                        </div>
                    </div>
                    <button id="downloadAppBtn" class="hidden px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg">
                        <i class="fas fa-download mr-2"></i>ë‹¤ìš´ë¡œë“œ
                    </button>
                </div>
            </div>

            <!-- ì‹¤ì‹œê°„ í†µê³„ -->
            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                <div class="bg-slate-800 rounded-lg p-6 border-l-4 border-red-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-400 mb-1">ë°©ì†¡ ìƒíƒœ</p>
                            <h3 id="liveStatus" class="text-2xl font-bold text-white">âš« ì˜¤í”„ë¼ì¸</h3>
                        </div>
                        <div class="bg-red-900 p-3 rounded-full">
                            <i class="fas fa-broadcast-tower text-red-400 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800 rounded-lg p-6 border-l-4 border-green-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-400 mb-1">ì‹œì²­ì</p>
                            <h3 id="viewerCount" class="text-2xl font-bold text-white">0</h3>
                        </div>
                        <div class="bg-green-900 p-3 rounded-full">
                            <i class="fas fa-users text-green-400 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800 rounded-lg p-6 border-l-4 border-blue-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-400 mb-1">ì´ ë©”ì‹œì§€</p>
                            <h3 id="messageCount" class="text-2xl font-bold text-white">0</h3>
                        </div>
                        <div class="bg-blue-900 p-3 rounded-full">
                            <i class="fas fa-comments text-blue-400 text-2xl"></i>
                        </div>
                    </div>
                </div>

                <div class="bg-slate-800 rounded-lg p-6 border-l-4 border-yellow-500">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-400 mb-1">ì„ ë¬¼</p>
                            <h3 id="giftCount" class="text-2xl font-bold text-white">0</h3>
                        </div>
                        <div class="bg-yellow-900 p-3 rounded-full">
                            <i class="fas fa-gift text-yellow-400 text-2xl"></i>
                        </div>
                    </div>
                </div>
            </div>

            <!-- TTS ì„¤ì • -->
            <div class="bg-slate-800 rounded-lg p-6 mb-6">
                <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                    <i class="fas fa-volume-up text-purple-400 mr-2"></i>
                    TTS ìŒì„± ì„¤ì •
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
                    <!-- TTS ON/OFF -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">TTS í™œì„±í™”</label>
                        <button id="ttsToggle" class="w-full px-4 py-2 bg-gray-700 hover:bg-gray-600 text-white rounded-lg transition">
                            <i class="fas fa-power-off mr-2"></i>
                            <span id="ttsToggleText">OFF</span>
                        </button>
                    </div>

                    <!-- ì–¸ì–´ ì„ íƒ -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">ì–¸ì–´</label>
                        <select id="ttsLanguage" class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg">
                            <option value="ko-KR">í•œêµ­ì–´</option>
                            <option value="en-US">English</option>
                            <option value="ja-JP">æ—¥æœ¬èª</option>
                            <option value="zh-CN">ä¸­æ–‡</option>
                        </select>
                    </div>

                    <!-- ëª©ì†Œë¦¬ ì„ íƒ -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">ëª©ì†Œë¦¬</label>
                        <select id="ttsVoice" class="w-full px-4 py-2 bg-gray-700 text-white rounded-lg">
                            <option value="female">ì—¬ì„±</option>
                            <option value="male">ë‚¨ì„±</option>
                        </select>
                    </div>

                    <!-- ì†ë„ -->
                    <div>
                        <label class="block text-sm text-gray-400 mb-2">ì†ë„: <span id="ttsSpeedValue">1.0</span>x</label>
                        <input id="ttsSpeed" type="range" min="0.5" max="2.0" step="0.1" value="1.0" class="w-full">
                    </div>
                </div>
            </div>

            <!-- ë©”ì¸ ì½˜í…ì¸  -->
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- ì‹¤ì‹œê°„ ì±„íŒ… -->
                <div class="bg-slate-800 rounded-lg p-6">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                        <i class="fas fa-comments text-blue-400 mr-2"></i>
                        ì‹¤ì‹œê°„ ì±„íŒ…
                    </h3>
                    <div id="chatMessages" class="h-96 overflow-y-auto space-y-2 bg-slate-900 rounded-lg p-4">
                        <p class="text-gray-500 text-center">ì±„íŒ… ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</p>
                    </div>
                </div>

                <!-- AI ìë™ì‘ë‹µ -->
                <div class="bg-slate-800 rounded-lg p-6">
                    <h3 class="text-xl font-bold text-white mb-4 flex items-center">
                        <i class="fas fa-robot text-purple-400 mr-2"></i>
                        AI ìë™ì‘ë‹µ
                    </h3>
                    <div id="aiResponses" class="h-96 overflow-y-auto space-y-2 bg-slate-900 rounded-lg p-4">
                        <p class="text-gray-500 text-center">AI ì‘ë‹µì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</p>
                    </div>
                </div>

                <!-- ì‹ ì²­ê³¡ í ('ë“¤ì–´ì£¼ì„¸ìš”' ìŠ¤íƒ€ì¼) -->
                <div class="bg-slate-800 rounded-lg lg:col-span-2 flex flex-col border border-purple-500/50 shadow-[0_0_15px_rgba(168,85,247,0.4)]">
                    <!-- í—¤ë” -->
                    <div class="flex items-center justify-between p-4 border-b border-white/10">
                        <div class="flex items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-5 h-5 text-purple-400">
                                <path d="M21 15V6"></path>
                                <path d="M18.5 18a2.5 2.5 0 1 0 0-5 2.5 2.5 0 0 0 0 5Z"></path>
                                <path d="M12 12H3"></path>
                                <path d="M16 6H3"></path>
                                <path d="M12 18H3"></path>
                            </svg>
                            <span class="font-bold text-white">ì‹ ì²­ ëŒ€ê¸°ì—´</span>
                            <span class="text-gray-400">(<span id="queueCount">0</span>)</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button id="testSongBtn" class="px-3 py-1.5 bg-purple-600 hover:bg-purple-700 text-white rounded-full text-xs font-medium transition-colors">
                                <i class="fas fa-plus mr-1"></i>í…ŒìŠ¤íŠ¸ ì¶”ê°€
                            </button>
                            <button id="pauseBtn" class="px-3 py-1.5 bg-orange-500 hover:bg-orange-600 text-white rounded-full text-xs font-medium transition-colors hidden">
                                <i class="fas fa-pause mr-1"></i>ì¼ì‹œì¤‘ë‹¨
                            </button>
                            <button id="nextBtn" class="px-3 py-1.5 bg-blue-600 hover:bg-blue-700 text-white rounded-full text-xs font-medium transition-colors">
                                <i class="fas fa-forward mr-1"></i>ë‹¤ìŒ ê³¡
                            </button>
                        </div>
                    </div>
                    
                    <!-- YouTube í”Œë ˆì´ì–´ -->
                    <div class="bg-slate-900">
                        <div id="youtubePlayer" class="aspect-video bg-slate-950 flex items-center justify-center">
                            <p class="text-gray-500">ì‹ ì²­ê³¡ì´ ì—†ìŠµë‹ˆë‹¤</p>
                        </div>
                        <div id="nowPlaying" class="p-3 border-t border-white/10 hidden">
                            <p class="text-xs text-gray-400">ì¬ìƒ ì¤‘</p>
                            <p class="font-semibold text-white text-sm" id="currentSongTitle">-</p>
                            <p class="text-xs text-gray-400 mt-0.5">ì‹ ì²­: <span id="currentRequester">-</span></p>
                        </div>
                    </div>
                    
                    <!-- ì‹ ì²­ê³¡ ëŒ€ê¸°ì—´ ë¦¬ìŠ¤íŠ¸ -->
                    <div class="flex-1 overflow-y-auto max-h-96">
                        <div id="songQueue" class="space-y-1 py-2 px-2">
                            <p class="text-gray-500 text-center py-4 text-sm">ì‹ ì²­ê³¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</p>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <!-- Desktop App ë‹¤ìš´ë¡œë“œ ëª¨ë‹¬ -->
    <div id="installModal" class="hidden fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50">
        <div class="bg-slate-800 rounded-lg p-8 max-w-md w-full mx-4">
            <h3 class="text-2xl font-bold text-white mb-4">
                <i class="fas fa-download text-blue-400 mr-2"></i>
                Desktop App ì„¤ì¹˜ í•„ìš”
            </h3>
            <p class="text-gray-300 mb-6">
                TikTok Live ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ë ¤ë©´ Desktop Appì„ ì„¤ì¹˜í•´ì•¼ í•©ë‹ˆë‹¤.
            </p>
            <div class="space-y-3">
                <a href="/downloads/TikFind-Setup.exe" class="block w-full px-6 py-3 bg-blue-600 hover:bg-blue-700 text-white text-center rounded-lg font-semibold">
                    <i class="fab fa-windows mr-2"></i>Windows ë‹¤ìš´ë¡œë“œ
                </a>
                <a href="/downloads/TikFind.dmg" class="block w-full px-6 py-3 bg-gray-600 hover:bg-gray-700 text-white text-center rounded-lg font-semibold">
                    <i class="fab fa-apple mr-2"></i>Mac ë‹¤ìš´ë¡œë“œ
                </a>
                <button onclick="closeInstallModal()" class="block w-full px-6 py-3 bg-gray-700 hover:bg-gray-600 text-white text-center rounded-lg">
                    ë‹«ê¸°
                </button>
            </div>
        </div>
    </div>

    <script src="/js/i18n.js"></script>
    <script src="/js/layout.js"></script>
    <script>
        const socket = io();
        let currentUser = null;
        let ttsEnabled = false;
        let messageCount = 0;
        let giftCount = 0;
        let songQueue = [];

        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/current_user');
                const data = await response.json();
                
                if (data.success && data.user) {
                    currentUser = data.user;
                    const userId = String(currentUser._id || currentUser.id);
                    console.log('âœ… ì‚¬ìš©ì ë¡œë“œ:', currentUser);
                    console.log('ğŸ”‘ User ID:', userId);
                    
                    // userId í‘œì‹œ
                    document.getElementById('userIdDisplay').textContent = userId;
                } else {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                window.location.href = '/';
            }
        }

        // ë¼ì´ë¸Œ ì‹œì‘
        document.getElementById('startLiveBtn').onclick = async () => {
            if (!currentUser) {
                alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...');
                return;
            }

            if (!currentUser.tiktokId) {
                alert('ì„¤ì • í˜ì´ì§€ì—ì„œ TikTok IDë¥¼ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.');
                window.location.href = '/dashboard/settings';
                return;
            }

            const userId = String(currentUser._id || currentUser.id);
            const tiktokId = currentUser.tiktokId;

            console.log('ğŸ¥ ë¼ì´ë¸Œ ì‹œì‘ ëª…ë ¹ ì „ì†¡:', { userId, tiktokId });

            // Socket.ioë¡œ Desktop Appì— ëª…ë ¹ ì „ì†¡
            socket.emit('start-live', { userId, tiktokId });

            // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            const btn = document.getElementById('startLiveBtn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ì—°ê²° ì¤‘...';

            // 5ì´ˆ í›„ ë²„íŠ¼ ë³µêµ¬
            setTimeout(() => {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-rocket mr-2"></i>ë¼ì´ë¸Œ ì‹œì‘';
            }, 5000);
        };

        // Desktop App ì—°ê²° í™•ì¸
        function checkDesktopAppConnection() {
            // Socket.ioë¡œ ì—°ê²° ìƒíƒœ í™•ì¸
            if (!socket.connected) {
                showInstallModal();
            }
        }

        // ì„¤ì¹˜ ëª¨ë‹¬ í‘œì‹œ
        function showInstallModal() {
            document.getElementById('installModal').classList.remove('hidden');
            document.getElementById('appStatusText').textContent = 'ë¯¸ì„¤ì¹˜';
            document.getElementById('downloadAppBtn').classList.remove('hidden');
        }

        // ì„¤ì¹˜ ëª¨ë‹¬ ë‹«ê¸°
        function closeInstallModal() {
            document.getElementById('installModal').classList.add('hidden');
        }

        // Socket.io ì´ë²¤íŠ¸
        socket.on('connect', () => {
            console.log('âœ… Socket.io ì—°ê²°');
            document.getElementById('appStatusText').textContent = 'ì—°ê²°ë¨';
            document.getElementById('downloadAppBtn').classList.add('hidden');
            
            if (currentUser) {
                const userId = String(currentUser._id || currentUser.id);
                console.log('ğŸ”‘ ë£¸ ì°¸ê°€:', userId);
                socket.emit('join-room', userId);
            }
        });

        socket.on('disconnect', () => {
            console.log('âŒ Socket.io ì—°ê²° ëŠê¹€');
            document.getElementById('appStatusText').textContent = 'ì—°ê²° ëŠê¹€';
        });

        // ë°©ì†¡ ìƒíƒœ
        socket.on('live-status', (data) => {
            if (data.isLive) {
                document.getElementById('liveStatus').innerHTML = 'ğŸ”´ ë°©ì†¡ ì¤‘';
                document.getElementById('liveStatus').classList.add('text-red-500');
            } else {
                document.getElementById('liveStatus').innerHTML = 'âš« ì˜¤í”„ë¼ì¸';
                document.getElementById('liveStatus').classList.remove('text-red-500');
            }
        });

        // ì‹œì²­ì ìˆ˜
        socket.on('viewer-update', (data) => {
            document.getElementById('viewerCount').textContent = data.viewerCount.toLocaleString();
        });

        // ì±„íŒ… ë©”ì‹œì§€
        socket.on('chat-message', (data) => {
            messageCount++;
            document.getElementById('messageCount').textContent = messageCount.toLocaleString();
            
            addChatMessage(data);
            
            // AI ì‘ë‹µ í‘œì‹œ
            if (data.aiResponse) {
                addAIResponse(data);
            }
            
            // ì‹ ì²­ê³¡ ì¶”ê°€
            if (data.songRequest) {
                addSongToQueue(data.songRequest, data.username);
            }
        });

        // ì„ ë¬¼
        socket.on('gift-received', (data) => {
            giftCount += data.count || 1;
            document.getElementById('giftCount').textContent = giftCount.toLocaleString();
            
            addGiftMessage(data);
        });

        // ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€
        function addChatMessage(data) {
            const chatDiv = document.getElementById('chatMessages');
            const empty = chatDiv.querySelector('.text-gray-500');
            if (empty) empty.remove();
            
            const messageEl = document.createElement('div');
            messageEl.className = 'bg-slate-800 rounded-lg p-3';
            
            const languageEmoji = {
                'ko': 'ğŸ‡°ğŸ‡·',
                'en': 'ğŸ‡ºğŸ‡¸',
                'ja': 'ğŸ‡¯ğŸ‡µ',
                'zh': 'ğŸ‡¨ğŸ‡³'
            };
            
            messageEl.innerHTML = `
                <p class="font-semibold text-blue-400">${languageEmoji[data.language] || 'ğŸŒ'} @${data.username}</p>
                <p class="text-sm text-white">${escapeHtml(data.message)}</p>
                <p class="text-xs text-gray-500">${new Date(data.timestamp).toLocaleTimeString()}</p>
            `;
            
            chatDiv.appendChild(messageEl);
            chatDiv.scrollTop = chatDiv.scrollHeight;
            
            // ìµœëŒ€ 50ê°œ ìœ ì§€
            while (chatDiv.children.length > 50) {
                chatDiv.removeChild(chatDiv.firstChild);
            }
        }

        // AI ì‘ë‹µ ì¶”ê°€
        function addAIResponse(data) {
            const aiDiv = document.getElementById('aiResponses');
            const empty = aiDiv.querySelector('.text-gray-500');
            if (empty) empty.remove();
            
            const responseEl = document.createElement('div');
            responseEl.className = 'bg-purple-900 rounded-lg p-3';
            responseEl.innerHTML = `
                <p class="font-semibold text-purple-300">ğŸ¤– AI â†’ @${data.username}</p>
                <div class="text-sm text-gray-200 whitespace-pre-line">${escapeHtml(data.aiResponse)}</div>
                <p class="text-xs text-gray-500">${new Date(data.timestamp).toLocaleTimeString()}</p>
            `;
            
            aiDiv.appendChild(responseEl);
            aiDiv.scrollTop = aiDiv.scrollHeight;
            
            while (aiDiv.children.length > 50) {
                aiDiv.removeChild(aiDiv.firstChild);
            }
        }

        // ì„ ë¬¼ ë©”ì‹œì§€ ì¶”ê°€
        function addGiftMessage(data) {
            const chatDiv = document.getElementById('chatMessages');
            const giftEl = document.createElement('div');
            giftEl.className = 'bg-yellow-900 rounded-lg p-3';
            giftEl.innerHTML = `
                <p class="font-semibold text-yellow-400">ğŸ ì„ ë¬¼: ${data.giftName} x${data.count || 1}</p>
                <p class="text-sm text-white">from @${data.username}</p>
                <p class="text-xs text-gray-500">${new Date().toLocaleTimeString()}</p>
            `;
            chatDiv.appendChild(giftEl);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        }

        // ì‹ ì²­ê³¡ ì¶”ê°€
        async function addSongToQueue(song, requester) {
            const queueDiv = document.getElementById('songQueue');
            const empty = queueDiv.querySelector('.text-gray-500');
            if (empty) empty.remove();
            
            // YouTube ë¹„ë””ì˜¤ ID ì¶”ì¶œ
            let videoId = null;
            if (song.videoId) {
                videoId = song.videoId;
            } else if (typeof song === 'string' && song.includes('youtube.com')) {
                const urlParams = new URLSearchParams(new URL(song).search);
                videoId = urlParams.get('v');
            }
            
            const songId = Date.now();
            const songData = {
                id: songId,
                title: song.title || song,
                artist: song.artist || '',
                videoId: videoId,
                thumbnail: song.thumbnail || (videoId ? `https://i.ytimg.com/vi/${videoId}/hqdefault.jpg` : ''),
                requester: requester,
                youtubeUrl: song.youtubeUrl || song.url || `https://www.youtube.com/watch?v=${videoId}`
            };
            
            songQueue.push(songData);
            updateSongQueue();
            
            // ì²« ë²ˆì§¸ ê³¡ì´ë©´ ìë™ ì¬ìƒ
            if (songQueue.length === 1) {
                await playNextSong();
            }
        }

        // ì‹ ì²­ê³¡ í ì—…ë°ì´íŠ¸ ('ë“¤ì–´ì£¼ì„¸ìš”' ìŠ¤íƒ€ì¼)
        function updateSongQueue() {
            const queueDiv = document.getElementById('songQueue');
            queueDiv.innerHTML = '';
            
            // í ì¹´ìš´íŠ¸ ì—…ë°ì´íŠ¸
            document.getElementById('queueCount').textContent = songQueue.length;
            
            if (songQueue.length === 0) {
                queueDiv.innerHTML = '<p class="text-gray-500 text-center py-4 text-sm">ì‹ ì²­ê³¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</p>';
            } else {
                songQueue.forEach((item, index) => {
                    const isPlaying = index === 0;
                    const songEl = document.createElement('div');
                    songEl.className = `flex items-center gap-1.5 py-1.5 pl-2 pr-3 rounded-lg ${isPlaying ? 'bg-primary/20' : 'hover:bg-slate-700/50'}`;
                    songEl.innerHTML = `
                        <div class="w-3.5 text-center text-sm font-medium shrink-0 ${isPlaying ? 'text-primary' : 'text-gray-400'}">
                            ${isPlaying ? 'â–¶' : index}
                        </div>
                        <img src="${item.thumbnail}" alt="ì¸ë„¤ì¼" class="rounded object-cover w-12 h-9 flex-shrink-0">
                        <div class="flex-1 min-w-0">
                            <p class="font-medium text-sm text-gray-200 line-clamp-3 break-words leading-tight">${escapeHtml(item.title)}</p>
                            <p class="text-xs text-gray-400 truncate mt-0.5">${escapeHtml(item.artist)}</p>
                            <div class="flex items-center gap-1 text-xs mt-0.5">
                                <span class="text-gray-500">${escapeHtml(item.requester)}</span>
                            </div>
                        </div>
                        ${isPlaying ? '<svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5 text-primary shrink-0 animate-spin"><path d="M3 12a9 9 0 0 1 9-9 9.75 9.75 0 0 1 6.74 2.74L21 8"></path><path d="M21 3v5h-5"></path><path d="M21 12a9 9 0 0 1-9 9 9.75 9.75 0 0 1-6.74-2.74L3 16"></path><path d="M8 16H3v5"></path></svg>' : `<button onclick="removeSong(${item.id})" class="px-2 py-1 bg-red-600 hover:bg-red-700 rounded text-xs text-white shrink-0">ì‚­ì œ</button>`}
                    `;
                    queueDiv.appendChild(songEl);
                });
            }
        }

        // ì‹ ì²­ê³¡ ì‚­ì œ
        function removeSong(songId) {
            songQueue = songQueue.filter(item => item.id !== songId);
            updateSongQueue();
        }
        
        // ë‹¤ìŒ ê³¡ ì¬ìƒ
        let currentPlayer = null;
        async function playNextSong() {
            if (songQueue.length === 0) {
                // ì¬ìƒí•  ê³¡ì´ ì—†ìœ¼ë©´ í”Œë ˆì´ì–´ ìˆ¨ê¹€
                document.getElementById('nowPlaying').classList.add('hidden');
                document.getElementById('youtubePlayer').innerHTML = '<div class="flex items-center justify-center h-full bg-slate-950 text-gray-500"><p>ì‹ ì²­ê³¡ì´ ì—†ìŠµë‹ˆë‹¤</p></div>';
                return;
            }
            
            const currentSong = songQueue[0];
            console.log('ğŸµ ì¬ìƒ ì‹œì‘:', currentSong);
            
            // í˜„ì¬ ì¬ìƒ ì¤‘ ì •ë³´ í‘œì‹œ
            document.getElementById('nowPlaying').classList.remove('hidden');
            document.getElementById('currentSongTitle').textContent = currentSong.title;
            document.getElementById('currentRequester').textContent = currentSong.requester;
            
            try {
                // ì„œë²„ì—ì„œ ìŠ¤íŠ¸ë¦¼ URL ê°€ì ¸ì˜¤ê¸°
                const response = await fetch('/api/youtube/stream', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ videoId: currentSong.videoId })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    // HTML5 video íƒœê·¸ë¡œ ì¬ìƒ
                    const playerDiv = document.getElementById('youtubePlayer');
                    playerDiv.innerHTML = `
                        <video id="videoPlayer" class="w-full h-full" controls autoplay>
                            <source src="${data.streamUrl}" type="video/mp4">
                            ë¸Œë¼ìš°ì €ê°€ ë¹„ë””ì˜¤ë¥¼ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.
                        </video>
                    `;
                    
                    const videoPlayer = document.getElementById('videoPlayer');
                    currentPlayer = videoPlayer;
                    
                    // ì¬ìƒ ì¢…ë£Œ ì‹œ ë‹¤ìŒ ê³¡ ì¬ìƒ
                    videoPlayer.onended = () => {
                        console.log('âœ… ì¬ìƒ ì™„ë£Œ, ë‹¤ìŒ ê³¡ìœ¼ë¡œ...');
                        songQueue.shift(); // ì²« ë²ˆì§¸ ê³¡ ì œê±°
                        updateSongQueue();
                        playNextSong();
                    };
                    
                    // ì—ëŸ¬ ì²˜ë¦¬
                    videoPlayer.onerror = (e) => {
                        console.error('âŒ ë¹„ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜:', e);
                        alert('ë¹„ë””ì˜¤ ì¬ìƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë‹¤ìŒ ê³¡ìœ¼ë¡œ ë„˜ì–´ê°‘ë‹ˆë‹¤.');
                        songQueue.shift();
                        updateSongQueue();
                        playNextSong();
                    };
                    
                    updateSongQueue();
                } else {
                    throw new Error(data.message);
                }
            } catch (error) {
                console.error('âŒ YouTube ìŠ¤íŠ¸ë¦¼ ë¡œë“œ ì‹¤íŒ¨:', error);
                alert('YouTube ìŠ¤íŠ¸ë¦¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤: ' + error.message);
                songQueue.shift();
                updateSongQueue();
                playNextSong();
            }
        }

        // TTS í† ê¸€
        document.getElementById('ttsToggle').onclick = () => {
            ttsEnabled = !ttsEnabled;
            const toggleBtn = document.getElementById('ttsToggle');
            const toggleText = document.getElementById('ttsToggleText');
            
            if (ttsEnabled) {
                toggleBtn.classList.remove('bg-gray-700');
                toggleBtn.classList.add('bg-green-600');
                toggleText.textContent = 'ON';
                
                // ì„œë²„ë¡œ TTS ì„¤ì • ì „ì†¡
                sendTTSSettings();
            } else {
                toggleBtn.classList.remove('bg-green-600');
                toggleBtn.classList.add('bg-gray-700');
                toggleText.textContent = 'OFF';
                
                sendTTSSettings();
            }
        };

        // TTS ì„¤ì • ë³€ê²½
        document.getElementById('ttsLanguage').onchange = sendTTSSettings;
        document.getElementById('ttsVoice').onchange = sendTTSSettings;
        document.getElementById('ttsSpeed').oninput = (e) => {
            document.getElementById('ttsSpeedValue').textContent = e.target.value;
            sendTTSSettings();
        };

        // TTS ì„¤ì • ì „ì†¡
        function sendTTSSettings() {
            const settings = {
                enabled: ttsEnabled,
                language: document.getElementById('ttsLanguage').value,
                voice: document.getElementById('ttsVoice').value,
                speed: parseFloat(document.getElementById('ttsSpeed').value)
            };
            
            socket.emit('tts-settings', settings);
            console.log('ğŸ”Š TTS ì„¤ì • ì „ì†¡:', settings);
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // í…ŒìŠ¤íŠ¸ ì‹ ì²­ê³¡ ì¶”ê°€ ë²„íŠ¼
        document.getElementById('testSongBtn').onclick = async () => {
            const testSongs = [
                { videoId: 'gdZLi9oWNZg', title: 'Dynamite', artist: 'BTS', requester: 'TestUser1' },
                { videoId: 'WMweEpGlu_U', title: 'Butter', artist: 'BTS', requester: 'TestUser2' },
                { videoId: 'z6rxN94JkfU', title: 'ë¡¤ë¦°', artist: 'ë¸Œë ˆì´ë¸Œê±¸ìŠ¤', requester: 'TestUser3' },
                { videoId: '32si5cfrCNc', title: 'How You Like That', artist: 'BLACKPINK', requester: 'TestUser4' }
            ];
            
            // ëœë¤ìœ¼ë¡œ í•˜ë‚˜ ì„ íƒ
            const randomSong = testSongs[Math.floor(Math.random() * testSongs.length)];
            
            console.log('ğŸµ í…ŒìŠ¤íŠ¸ ì‹ ì²­ê³¡ ì¶”ê°€:', randomSong);
            
            await addSongToQueue(randomSong, randomSong.requester);
            
            // ë²„íŠ¼ í”¼ë“œë°±
            const btn = document.getElementById('testSongBtn');
            const originalText = btn.innerHTML;
            btn.innerHTML = '<i class="fas fa-check mr-1"></i>ì¶”ê°€ë¨!';
            btn.disabled = true;
            
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.disabled = false;
            }, 1000);
        };

        // ë‹¤ìŒ ê³¡ ë²„íŠ¼
        document.getElementById('nextBtn').onclick = () => {
            if (songQueue.length > 0) {
                console.log('â­ï¸ ë‹¤ìŒ ê³¡ìœ¼ë¡œ ìŠ¤í‚µ');
                if (currentPlayer) {
                    currentPlayer.pause();
                }
                songQueue.shift(); // í˜„ì¬ ê³¡ ì œê±°
                updateSongQueue();
                playNextSong();
            }
        };

        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserInfo();
        });
    </script>
</body>
</html>
