<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI ìë™ì¬ìƒ ê³¡ ê´€ë¦¬ - TikFind Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-900 text-white">
    <div class="container mx-auto px-4 py-8">
        <div class="mb-8">
            <h1 class="text-3xl font-bold mb-2">ğŸµ AI ìë™ì¬ìƒ ê³¡ ê´€ë¦¬</h1>
            <p class="text-gray-400">ì¥ë¥´ë³„ 50ê³¡ì”© íë ˆì´ì…˜í•˜ì—¬ AI ìë™ì¬ìƒ í’ˆì§ˆì„ ê´€ë¦¬í•˜ì„¸ìš”</p>
        </div>

        <!-- ì¥ë¥´ íƒ­ -->
        <div class="mb-6 flex gap-2 flex-wrap">
            <button class="genre-tab px-4 py-2 rounded-lg bg-purple-600 hover:bg-purple-700" data-genre="all">
                ì „ì²´
            </button>
            <button class="genre-tab px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600" data-genre="kpop">
                K-POP
            </button>
            <button class="genre-tab px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600" data-genre="pop">
                POP
            </button>
            <button class="genre-tab px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600" data-genre="hiphop">
                í™í•©/R&B
            </button>
            <button class="genre-tab px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600" data-genre="dance">
                ëŒ„ìŠ¤/EDM
            </button>
            <button class="genre-tab px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600" data-genre="ballad">
                ë°œë¼ë“œ
            </button>
            <button class="genre-tab px-4 py-2 rounded-lg bg-gray-700 hover:bg-gray-600" data-genre="tiktok_trend">
                í‹±í†¡ íŠ¸ë Œë“œ
            </button>
        </div>

        <!-- í†µê³„ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-gray-800 p-4 rounded-lg">
                <div class="text-gray-400 text-sm">ì „ì²´ ê³¡ ìˆ˜</div>
                <div class="text-2xl font-bold" id="total-songs">0</div>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg">
                <div class="text-gray-400 text-sm">íë ˆì´ì…˜ ê³¡</div>
                <div class="text-2xl font-bold text-purple-400" id="curated-songs">0</div>
            </div>
            <div class="bg-gray-800 p-4 rounded-lg">
                <div class="text-gray-400 text-sm">í˜„ì¬ ì¥ë¥´ íë ˆì´ì…˜</div>
                <div class="text-2xl font-bold text-green-400" id="genre-curated">0 / 50</div>
            </div>
        </div>

        <!-- ê²€ìƒ‰ -->
        <div class="mb-6">
            <div class="flex gap-2">
                <input type="text" id="search-input" placeholder="ê³¡ ì œëª© ë˜ëŠ” ì•„í‹°ìŠ¤íŠ¸ ê²€ìƒ‰..." 
                    class="flex-1 px-4 py-2 bg-gray-800 rounded-lg border border-gray-700 focus:border-purple-500 focus:outline-none">
                <button onclick="searchSongs()" class="px-6 py-2 bg-purple-600 hover:bg-purple-700 rounded-lg">
                    <i class="fas fa-search mr-2"></i>ê²€ìƒ‰
                </button>
            </div>
        </div>

        <!-- ê³¡ ëª©ë¡ -->
        <div class="bg-gray-800 rounded-lg overflow-hidden">
            <table class="w-full">
                <thead class="bg-gray-700">
                    <tr>
                        <th class="px-4 py-3 text-left">ìš°ì„ ìˆœìœ„</th>
                        <th class="px-4 py-3 text-left">ì¸ë„¤ì¼</th>
                        <th class="px-4 py-3 text-left">ì œëª©</th>
                        <th class="px-4 py-3 text-left">ì•„í‹°ìŠ¤íŠ¸</th>
                        <th class="px-4 py-3 text-left">ì¥ë¥´</th>
                        <th class="px-4 py-3 text-left">ì‹ ì²­ íšŸìˆ˜</th>
                        <th class="px-4 py-3 text-center">íë ˆì´ì…˜</th>
                        <th class="px-4 py-3 text-center">ì•¡ì…˜</th>
                    </tr>
                </thead>
                <tbody id="songs-table">
                    <tr>
                        <td colspan="8" class="px-4 py-8 text-center text-gray-400">
                            ë¡œë”© ì¤‘...
                        </td>
                    </tr>
                </tbody>
            </table>
        </div>

        <!-- í˜ì´ì§€ë„¤ì´ì…˜ -->
        <div class="mt-6 flex justify-center gap-2" id="pagination">
        </div>
    </div>

    <script>
        let currentGenre = 'all';
        let currentPage = 1;
        const pageSize = 50;

        // ì¥ë¥´ íƒ­ í´ë¦­
        document.querySelectorAll('.genre-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                currentGenre = tab.dataset.genre;
                currentPage = 1;
                
                // íƒ­ ìŠ¤íƒ€ì¼ ì—…ë°ì´íŠ¸
                document.querySelectorAll('.genre-tab').forEach(t => {
                    t.classList.remove('bg-purple-600');
                    t.classList.add('bg-gray-700');
                });
                tab.classList.remove('bg-gray-700');
                tab.classList.add('bg-purple-600');
                
                loadSongs();
            });
        });

        // ê³¡ ëª©ë¡ ë¡œë“œ
        async function loadSongs() {
            try {
                const query = new URLSearchParams({
                    genre: currentGenre,
                    page: currentPage,
                    limit: pageSize
                });

                const response = await fetch(`/api/admin/songs?${query}`);
                const data = await response.json();

                if (data.success) {
                    renderSongs(data.songs);
                    renderPagination(data.total);
                    updateStats(data.stats);
                }
            } catch (error) {
                console.error('ê³¡ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ê³¡ ë Œë”ë§
        function renderSongs(songs) {
            const tbody = document.getElementById('songs-table');
            
            if (songs.length === 0) {
                tbody.innerHTML = '<tr><td colspan="8" class="px-4 py-8 text-center text-gray-400">ê³¡ì´ ì—†ìŠµë‹ˆë‹¤</td></tr>';
                return;
            }

            tbody.innerHTML = songs.map(song => `
                <tr class="border-t border-gray-700 hover:bg-gray-750">
                    <td class="px-4 py-3">
                        ${song.isCurated ? `
                            <input type="number" value="${song.curatedPriority || 1}" min="1" max="50" 
                                class="w-16 px-2 py-1 bg-gray-700 rounded text-center"
                                onchange="updatePriority('${song._id}', this.value)">
                        ` : '-'}
                    </td>
                    <td class="px-4 py-3">
                        <img src="${song.thumbnail}" alt="${song.title}" class="w-16 h-12 object-cover rounded">
                    </td>
                    <td class="px-4 py-3">${song.title}</td>
                    <td class="px-4 py-3">${song.artist}</td>
                    <td class="px-4 py-3">
                        <span class="px-2 py-1 bg-gray-700 rounded text-xs">${song.genre}</span>
                    </td>
                    <td class="px-4 py-3">${song.requestCount || 0}íšŒ</td>
                    <td class="px-4 py-3 text-center">
                        ${song.isCurated ? 
                            '<span class="text-green-400"><i class="fas fa-check-circle"></i> íë ˆì´ì…˜</span>' : 
                            '<span class="text-gray-500">-</span>'
                        }
                    </td>
                    <td class="px-4 py-3 text-center">
                        ${song.isCurated ? `
                            <button onclick="removeCuration('${song._id}')" 
                                class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm">
                                ì œê±°
                            </button>
                        ` : `
                            <button onclick="addCuration('${song._id}')" 
                                class="px-3 py-1 bg-purple-600 hover:bg-purple-700 rounded text-sm">
                                ì¶”ê°€
                            </button>
                        `}
                        <a href="https://www.youtube.com/watch?v=${song.videoId}" target="_blank"
                            class="ml-2 px-3 py-1 bg-gray-600 hover:bg-gray-500 rounded text-sm">
                            <i class="fab fa-youtube"></i>
                        </a>
                    </td>
                </tr>
            `).join('');
        }

        // í†µê³„ ì—…ë°ì´íŠ¸
        function updateStats(stats) {
            document.getElementById('total-songs').textContent = stats.total.toLocaleString();
            document.getElementById('curated-songs').textContent = stats.curated.toLocaleString();
            document.getElementById('genre-curated').textContent = `${stats.genreCurated} / 50`;
        }

        // í˜ì´ì§€ë„¤ì´ì…˜
        function renderPagination(total) {
            const totalPages = Math.ceil(total / pageSize);
            const pagination = document.getElementById('pagination');
            
            let html = '';
            for (let i = 1; i <= totalPages; i++) {
                html += `
                    <button onclick="goToPage(${i})" 
                        class="px-4 py-2 rounded ${i === currentPage ? 'bg-purple-600' : 'bg-gray-700 hover:bg-gray-600'}">
                        ${i}
                    </button>
                `;
            }
            pagination.innerHTML = html;
        }

        function goToPage(page) {
            currentPage = page;
            loadSongs();
        }

        // íë ˆì´ì…˜ ì¶”ê°€
        async function addCuration(songId) {
            try {
                const response = await fetch('/api/admin/songs/curate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ songId, action: 'add' })
                });

                const data = await response.json();
                if (data.success) {
                    alert('íë ˆì´ì…˜ì— ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤');
                    loadSongs();
                } else {
                    alert(data.message || 'ì¶”ê°€ ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('íë ˆì´ì…˜ ì¶”ê°€ ì‹¤íŒ¨:', error);
                alert('ì¶”ê°€ ì‹¤íŒ¨');
            }
        }

        // íë ˆì´ì…˜ ì œê±°
        async function removeCuration(songId) {
            if (!confirm('íë ˆì´ì…˜ì—ì„œ ì œê±°í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

            try {
                const response = await fetch('/api/admin/songs/curate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ songId, action: 'remove' })
                });

                const data = await response.json();
                if (data.success) {
                    alert('íë ˆì´ì…˜ì—ì„œ ì œê±°ë˜ì—ˆìŠµë‹ˆë‹¤');
                    loadSongs();
                } else {
                    alert(data.message || 'ì œê±° ì‹¤íŒ¨');
                }
            } catch (error) {
                console.error('íë ˆì´ì…˜ ì œê±° ì‹¤íŒ¨:', error);
                alert('ì œê±° ì‹¤íŒ¨');
            }
        }

        // ìš°ì„ ìˆœìœ„ ì—…ë°ì´íŠ¸
        async function updatePriority(songId, priority) {
            try {
                const response = await fetch('/api/admin/songs/priority', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ songId, priority: parseInt(priority) })
                });

                const data = await response.json();
                if (data.success) {
                    console.log('ìš°ì„ ìˆœìœ„ ì—…ë°ì´íŠ¸ ì™„ë£Œ');
                } else {
                    alert(data.message || 'ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
                    loadSongs();
                }
            } catch (error) {
                console.error('ìš°ì„ ìˆœìœ„ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨:', error);
                alert('ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
                loadSongs();
            }
        }

        // ê²€ìƒ‰
        async function searchSongs() {
            const keyword = document.getElementById('search-input').value;
            if (!keyword) {
                loadSongs();
                return;
            }

            try {
                const response = await fetch(`/api/admin/songs/search?keyword=${encodeURIComponent(keyword)}`);
                const data = await response.json();

                if (data.success) {
                    renderSongs(data.songs);
                    document.getElementById('pagination').innerHTML = '';
                }
            } catch (error) {
                console.error('ê²€ìƒ‰ ì‹¤íŒ¨:', error);
            }
        }

        // Enter í‚¤ë¡œ ê²€ìƒ‰
        document.getElementById('search-input').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') searchSongs();
        });

        // ì´ˆê¸° ë¡œë“œ
        loadSongs();
    </script>
</body>
</html>
