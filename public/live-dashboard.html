<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikFind Live Dashboard</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-gray-900 text-white">
    <div class="max-w-7xl mx-auto p-6">
        <!-- í—¤ë” -->
        <div class="bg-gradient-to-r from-purple-600 to-pink-600 rounded-lg p-6 mb-6">
            <h1 class="text-3xl font-bold mb-2">ğŸ¥ TikFind Live Dashboard</h1>
            <p class="text-gray-200">ì‹¤ì‹œê°„ TikTok Live ë°©ì†¡ ë³´ì¡° ë„êµ¬</p>
        </div>

        <!-- ì‚¬ìš©ì ì •ë³´ -->
        <div class="bg-gray-800 rounded-lg p-6 mb-6">
            <h2 class="text-xl font-semibold mb-4">ğŸ“‹ ì‚¬ìš©ì ì •ë³´</h2>
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div>
                    <p class="text-sm text-gray-400">ì´ë©”ì¼</p>
                    <p id="user-email" class="font-semibold">ë¡œë”© ì¤‘...</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">TikTok ID</p>
                    <p id="user-tiktok" class="font-semibold">ë¡œë”© ì¤‘...</p>
                </div>
                <div>
                    <p class="text-sm text-gray-400">ì‚¬ìš©ì ID</p>
                    <p id="user-id" class="font-mono text-sm bg-gray-700 px-2 py-1 rounded">ë¡œë”© ì¤‘...</p>
                </div>
            </div>
            <div class="mt-4 p-4 bg-blue-900 rounded">
                <p class="text-sm font-semibold mb-2">ğŸ Python Collector ì‹¤í–‰ ëª…ë ¹ì–´:</p>
                <code id="python-command" class="text-xs bg-gray-800 px-3 py-2 rounded block">ë¡œë”© ì¤‘...</code>
                <button onclick="copyCommand()" class="mt-2 px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded text-sm">
                    ğŸ“‹ ë³µì‚¬
                </button>
            </div>
        </div>

        <!-- ìƒíƒœ í‘œì‹œ -->
        <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-sm text-gray-400 mb-2">ë°©ì†¡ ìƒíƒœ</h3>
                <p id="live-status" class="text-2xl font-bold">âš« ì˜¤í”„ë¼ì¸</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-sm text-gray-400 mb-2">ì‹œì²­ì ìˆ˜</h3>
                <p id="viewer-count" class="text-2xl font-bold">0ëª…</p>
            </div>
            <div class="bg-gray-800 rounded-lg p-6">
                <h3 class="text-sm text-gray-400 mb-2">ì´ ë©”ì‹œì§€</h3>
                <p id="total-messages" class="text-2xl font-bold">0ê°œ</p>
            </div>
        </div>

        <!-- ì±„íŒ… ë° AI ì‘ë‹µ -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
            <!-- ì‹¤ì‹œê°„ ì±„íŒ… -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ’¬ ì‹¤ì‹œê°„ ì±„íŒ…</h2>
                <div id="chat-messages" class="h-96 overflow-y-auto space-y-2 bg-gray-900 rounded p-4">
                    <p class="text-gray-500 text-center">ì±„íŒ… ë©”ì‹œì§€ê°€ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</p>
                </div>
            </div>

            <!-- AI ìë™ì‘ë‹µ -->
            <div class="bg-gray-800 rounded-lg p-6">
                <h2 class="text-xl font-semibold mb-4">ğŸ¤– AI ìë™ì‘ë‹µ</h2>
                <div id="ai-responses" class="h-96 overflow-y-auto space-y-2 bg-gray-900 rounded p-4">
                    <p class="text-gray-500 text-center">AI ì‘ë‹µì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</p>
                </div>
            </div>
        </div>

        <!-- ì‹ ì²­ê³¡ í -->
        <div class="bg-gray-800 rounded-lg p-6">
            <h2 class="text-xl font-semibold mb-4">ğŸµ ì‹ ì²­ê³¡ í</h2>
            <div id="song-queue" class="space-y-2">
                <p class="text-gray-500 text-center">ì‹ ì²­ê³¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</p>
            </div>
        </div>
    </div>

    <script>
        const socket = io();
        let userId = null;
        let messageCount = 0;
        let songQueue = [];

        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/current_user');
                const data = await response.json();
                
                if (data.success && data.user) {
                    userId = data.user.id;
                    document.getElementById('user-email').textContent = data.user.email;
                    document.getElementById('user-tiktok').textContent = data.user.tiktokId || 'ë¯¸ì„¤ì •';
                    document.getElementById('user-id').textContent = userId;
                    
                    // Python ëª…ë ¹ì–´ ìƒì„±
                    const serverUrl = window.location.origin;
                    const tiktokId = data.user.tiktokId || 'YOUR_TIKTOK_ID';
                    const command = `python tiktok_collector.py --username ${tiktokId} --server ${serverUrl} --user-id ${userId}`;
                    document.getElementById('python-command').textContent = command;
                    
                    // Socket.io ë£¸ ì°¸ê°€
                    socket.emit('join-room', userId);
                } else {
                    alert('ë¡œê·¸ì¸ì´ í•„ìš”í•©ë‹ˆë‹¤.');
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ëª…ë ¹ì–´ ë³µì‚¬
        function copyCommand() {
            const command = document.getElementById('python-command').textContent;
            navigator.clipboard.writeText(command);
            alert('ëª…ë ¹ì–´ê°€ ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        }

        // Socket.io ì´ë²¤íŠ¸
        socket.on('connect', () => {
            console.log('âœ… Socket.io ì—°ê²° ì„±ê³µ');
        });

        // Live ìƒíƒœ ì—…ë°ì´íŠ¸
        socket.on('live-status', (data) => {
            if (data.isLive) {
                document.getElementById('live-status').innerHTML = 'ğŸ”´ ë°©ì†¡ ì¤‘';
                document.getElementById('live-status').classList.add('text-red-500');
            } else {
                document.getElementById('live-status').innerHTML = 'âš« ì˜¤í”„ë¼ì¸';
                document.getElementById('live-status').classList.remove('text-red-500');
            }
        });

        // ì‹œì²­ì ìˆ˜ ì—…ë°ì´íŠ¸
        socket.on('viewer-update', (data) => {
            document.getElementById('viewer-count').textContent = data.viewerCount + 'ëª…';
        });

        // ì±„íŒ… ë©”ì‹œì§€
        socket.on('chat-message', (data) => {
            messageCount++;
            document.getElementById('total-messages').textContent = messageCount + 'ê°œ';
            
            const chatDiv = document.getElementById('chat-messages');
            const messageEl = document.createElement('div');
            messageEl.className = 'bg-gray-800 rounded p-3';
            
            const isKorean = data.language === 'ko';
            const languageEmoji = {
                'ko': 'ğŸ‡°ğŸ‡·',
                'en': 'ğŸ‡ºğŸ‡¸',
                'ja': 'ğŸ‡¯ğŸ‡µ',
                'es': 'ğŸ‡ªğŸ‡¸',
                'zh-TW': 'ğŸ‡¨ğŸ‡³',
                'vi': 'ğŸ‡»ğŸ‡³',
                'th': 'ğŸ‡¹ğŸ‡­'
            };
            
            messageEl.innerHTML = `
                <p class="font-semibold text-blue-400">${languageEmoji[data.language] || 'ğŸŒ'} @${data.username}</p>
                <p class="text-sm">${data.message}</p>
                <p class="text-xs text-gray-500">${new Date(data.timestamp).toLocaleTimeString()}</p>
            `;
            chatDiv.appendChild(messageEl);
            chatDiv.scrollTop = chatDiv.scrollHeight;
            
            // AI ì‘ë‹µ í‘œì‹œ
            if (data.aiResponse) {
                const aiDiv = document.getElementById('ai-responses');
                const responseEl = document.createElement('div');
                responseEl.className = 'bg-purple-900 rounded p-3';
                responseEl.innerHTML = `
                    <p class="font-semibold text-purple-300">ğŸ¤– AI â†’ @${data.username}</p>
                    <div class="text-sm text-gray-200 whitespace-pre-line">${data.aiResponse}</div>
                    <p class="text-xs text-gray-500">${new Date(data.timestamp).toLocaleTimeString()}</p>
                `;
                aiDiv.appendChild(responseEl);
                aiDiv.scrollTop = aiDiv.scrollHeight;
            }
            
            // ì‹ ì²­ê³¡ ì¶”ê°€
            if (data.songRequest) {
                addSongToQueue(data.songRequest, data.username);
            }
        });

        // ì„ ë¬¼ ìˆ˜ì‹ 
        socket.on('gift-received', (data) => {
            const chatDiv = document.getElementById('chat-messages');
            const giftEl = document.createElement('div');
            giftEl.className = 'bg-yellow-900 rounded p-3';
            giftEl.innerHTML = `
                <p class="font-semibold text-yellow-400">ğŸ ì„ ë¬¼: ${data.giftName}</p>
                <p class="text-sm">from @${data.username}</p>
                <p class="text-xs text-gray-500">${new Date(data.timestamp).toLocaleTimeString()}</p>
            `;
            chatDiv.appendChild(giftEl);
            chatDiv.scrollTop = chatDiv.scrollHeight;
        });

        // ì‹ ì²­ê³¡ íì— ì¶”ê°€
        function addSongToQueue(song, requester) {
            const queueItem = {
                id: Date.now(),
                song,
                requester,
                timestamp: Date.now()
            };
            
            songQueue.push(queueItem);
            updateSongQueue();
        }

        // ì‹ ì²­ê³¡ í ì—…ë°ì´íŠ¸
        function updateSongQueue() {
            const queueDiv = document.getElementById('song-queue');
            queueDiv.innerHTML = '';
            
            if (songQueue.length === 0) {
                queueDiv.innerHTML = '<p class="text-gray-500 text-center">ì‹ ì²­ê³¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
            } else {
                songQueue.forEach((item, index) => {
                    const songEl = document.createElement('div');
                    songEl.className = 'bg-gray-900 rounded p-4 flex justify-between items-center';
                    songEl.innerHTML = `
                        <div>
                            <p class="font-semibold">${index + 1}. ${item.song.artist || ''} - ${item.song.title}</p>
                            <p class="text-sm text-gray-400">ì‹ ì²­: @${item.requester}</p>
                        </div>
                        <button onclick="removeSong(${item.id})" class="px-3 py-1 bg-red-600 hover:bg-red-700 rounded text-sm">
                            ì‚­ì œ
                        </button>
                    `;
                    queueDiv.appendChild(songEl);
                });
            }
        }

        // ì‹ ì²­ê³¡ ì‚­ì œ
        function removeSong(songId) {
            songQueue = songQueue.filter(item => item.id !== songId);
            updateSongQueue();
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        document.addEventListener('DOMContentLoaded', async () => {
            await loadUserInfo();
        });
    </script>
</body>
</html>
