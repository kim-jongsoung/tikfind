<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>User Management - TikFind Admin</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-100">
    <header class="bg-slate-900 text-white shadow-lg">
        <div class="container mx-auto px-4 py-4 flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <h1 class="text-2xl font-bold">TikFind Admin</h1>
                <span class="px-3 py-1 bg-red-600 text-xs rounded-full">ADMIN</span>
            </div>
            <div class="flex items-center space-x-4">
                <span id="admin-email" class="text-sm"></span>
                <a href="/dashboard" class="px-4 py-2 bg-blue-600 hover:bg-blue-700 rounded-lg text-sm">
                    <i class="fas fa-home mr-2"></i>User Dashboard
                </a>
                <a href="/auth/logout" class="px-4 py-2 bg-red-600 hover:bg-red-700 rounded-lg text-sm">
                    <i class="fas fa-sign-out-alt mr-2"></i>Logout
                </a>
            </div>
        </div>
    </header>

    <nav class="bg-white shadow-md">
        <div class="container mx-auto px-4">
            <ul class="flex space-x-8 py-4">
                <li><a href="/admin/dashboard" class="text-gray-600 hover:text-blue-600"><i class="fas fa-chart-line mr-2"></i>Dashboard</a></li>
                <li><a href="/admin/users" class="text-blue-600 font-semibold border-b-2 border-blue-600 pb-2"><i class="fas fa-users mr-2"></i>Users</a></li>
                <li><a href="/admin/subscriptions" class="text-gray-600 hover:text-blue-600"><i class="fas fa-credit-card mr-2"></i>Subscriptions</a></li>
                <li><a href="/admin/payments" class="text-gray-600 hover:text-blue-600"><i class="fas fa-dollar-sign mr-2"></i>Payments</a></li>
                <li><a href="/admin/logs" class="text-gray-600 hover:text-blue-600"><i class="fas fa-history mr-2"></i>Logs</a></li>
            </ul>
        </div>
    </nav>

    <main class="container mx-auto px-4 py-8">
        <div class="bg-white rounded-lg shadow-md p-6 mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="md:col-span-2">
                    <label class="block text-sm font-medium text-gray-700 mb-2">Search</label>
                    <input type="text" id="search-input" placeholder="Email, TikTok ID, or Nickname" 
                           class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-blue-500">
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Plan</label>
                    <select id="plan-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="">All Plans</option>
                        <option value="free">Free</option>
                        <option value="pro">Pro</option>
                    </select>
                </div>
                <div>
                    <label class="block text-sm font-medium text-gray-700 mb-2">Status</label>
                    <select id="status-filter" class="w-full px-4 py-2 border border-gray-300 rounded-lg">
                        <option value="">All Status</option>
                        <option value="trial">Trial</option>
                        <option value="active">Active</option>
                        <option value="cancelled">Cancelled</option>
                        <option value="expired">Expired</option>
                    </select>
                </div>
            </div>
            <div class="flex justify-between items-center mt-4">
                <button onclick="applyFilters()" class="px-6 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">
                    <i class="fas fa-search mr-2"></i>Search
                </button>
                <button onclick="resetFilters()" class="px-6 py-2 bg-gray-300 text-gray-700 rounded-lg hover:bg-gray-400">
                    <i class="fas fa-redo mr-2"></i>Reset
                </button>
                <a href="/admin/api/export/users" class="px-6 py-2 bg-green-600 text-white rounded-lg hover:bg-green-700">
                    <i class="fas fa-download mr-2"></i>Export CSV
                </a>
            </div>
        </div>

        <div class="bg-white rounded-lg shadow-md overflow-hidden">
            <div class="overflow-x-auto">
                <table class="w-full">
                    <thead class="bg-gray-50 border-b">
                        <tr>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">User</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">TikTok ID</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Plan</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Created</th>
                            <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="users-table-body" class="bg-white divide-y divide-gray-200">
                        <tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">
                            <i class="fas fa-spinner fa-spin text-2xl mb-2"></i><p>Loading...</p>
                        </td></tr>
                    </tbody>
                </table>
            </div>
            <div class="bg-gray-50 px-6 py-4 flex items-center justify-between border-t">
                <div class="text-sm text-gray-700">
                    Showing <span id="showing-from">0</span> to <span id="showing-to">0</span> of <span id="total-users">0</span> users
                </div>
                <div class="flex space-x-2" id="pagination-buttons"></div>
            </div>
        </div>
    </main>

    <script>
        let currentPage = 1;
        let currentFilters = {};

        async function loadAdminInfo() {
            try {
                const response = await fetch('/admin/auth/check');
                const data = await response.json();
                if (data.success && data.admin) {
                    document.getElementById('admin-email').textContent = data.admin.email;
                } else {
                    alert('Access denied. Admin privileges required.');
                    window.location.href = '/admin/login';
                }
            } catch (error) {
                console.error('Error loading admin info:', error);
                window.location.href = '/admin/login';
            }
        }

        async function loadUsers(page = 1) {
            const params = new URLSearchParams({ page, limit: 50, ...currentFilters });
            const response = await fetch(`/admin/api/users?${params}`);
            const data = await response.json();
            if (data.success) {
                displayUsers(data.users);
                displayPagination(data.pagination);
            }
        }

        function displayUsers(users) {
            const tbody = document.getElementById('users-table-body');
            if (users.length === 0) {
                tbody.innerHTML = '<tr><td colspan="6" class="px-6 py-8 text-center text-gray-500">No users found</td></tr>';
                return;
            }
            tbody.innerHTML = users.map(user => `
                <tr class="hover:bg-gray-50">
                    <td class="px-6 py-4">
                        <div class="flex items-center">
                            <img src="${user.profileImage || 'https://placehold.co/40x40?text=U'}" class="w-10 h-10 rounded-full mr-3">
                            <div>
                                <div class="text-sm font-medium">${user.nickname || 'No Name'}</div>
                                <div class="text-sm text-gray-500">${user.email}</div>
                            </div>
                        </div>
                    </td>
                    <td class="px-6 py-4 text-sm">${user.tiktokId || '-'}</td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full ${user.plan === 'pro' ? 'bg-green-100 text-green-800' : 'bg-gray-100 text-gray-800'}">
                            ${user.plan.toUpperCase()}
                        </span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="px-2 py-1 text-xs rounded-full ${getStatusColor(user.subscriptionStatus)}">
                            ${user.subscriptionStatus}
                        </span>
                    </td>
                    <td class="px-6 py-4 text-sm text-gray-500">${new Date(user.createdAt).toLocaleDateString()}</td>
                    <td class="px-6 py-4 text-sm">
                        <a href="/admin/users/${user._id}" class="text-blue-600 hover:text-blue-800">
                            <i class="fas fa-eye"></i> View
                        </a>
                    </td>
                </tr>
            `).join('');
        }

        function getStatusColor(status) {
            const colors = {
                'trial': 'bg-blue-100 text-blue-800',
                'active': 'bg-green-100 text-green-800',
                'cancelled': 'bg-yellow-100 text-yellow-800',
                'expired': 'bg-red-100 text-red-800'
            };
            return colors[status] || 'bg-gray-100 text-gray-800';
        }

        function displayPagination(pagination) {
            document.getElementById('showing-from').textContent = pagination.totalUsers > 0 ? ((pagination.currentPage - 1) * pagination.limit + 1) : 0;
            document.getElementById('showing-to').textContent = Math.min(pagination.currentPage * pagination.limit, pagination.totalUsers);
            document.getElementById('total-users').textContent = pagination.totalUsers;

            const container = document.getElementById('pagination-buttons');
            let buttons = '';
            if (pagination.hasPrevPage) {
                buttons += `<button onclick="loadUsers(${pagination.currentPage - 1})" class="px-3 py-1 bg-white border rounded hover:bg-gray-50">Previous</button>`;
            }
            for (let i = Math.max(1, pagination.currentPage - 2); i <= Math.min(pagination.totalPages, pagination.currentPage + 2); i++) {
                buttons += `<button onclick="loadUsers(${i})" class="px-3 py-1 ${i === pagination.currentPage ? 'bg-blue-600 text-white' : 'bg-white border'} rounded">${i}</button>`;
            }
            if (pagination.hasNextPage) {
                buttons += `<button onclick="loadUsers(${pagination.currentPage + 1})" class="px-3 py-1 bg-white border rounded hover:bg-gray-50">Next</button>`;
            }
            container.innerHTML = buttons;
        }

        function applyFilters() {
            currentFilters = {
                search: document.getElementById('search-input').value,
                plan: document.getElementById('plan-filter').value,
                status: document.getElementById('status-filter').value
            };
            loadUsers(1);
        }

        function resetFilters() {
            document.getElementById('search-input').value = '';
            document.getElementById('plan-filter').value = '';
            document.getElementById('status-filter').value = '';
            currentFilters = {};
            loadUsers(1);
        }

        document.addEventListener('DOMContentLoaded', () => {
            loadAdminInfo();
            loadUsers();
        });
    </script>
</body>
</html>
