<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikFind - ì„¤ì •</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body class="bg-gray-50">
    <div id="sidebar-container"></div>
    <div id="header-container"></div>
    
    <main class="ml-64 mt-16 p-8">
        <div class="max-w-4xl mx-auto">
            <div class="mb-8">
                <h2 class="text-3xl font-bold text-gray-800">ì„¤ì •</h2>
                <p class="text-gray-600 mt-2">ê³„ì • ë° ì„œë¹„ìŠ¤ ì„¤ì •ì„ ê´€ë¦¬í•˜ì„¸ìš”</p>
            </div>

            <div class="space-y-6">
                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-user mr-2 text-indigo-600"></i>
                        í”„ë¡œí•„ ì •ë³´
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ì´ë©”ì¼</label>
                            <input type="email" id="user-email" disabled class="w-full px-4 py-2 border border-gray-300 rounded-lg bg-gray-50">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ë‹‰ë„¤ì„</label>
                            <input type="text" id="user-nickname" placeholder="ë‹‰ë„¤ì„ ì…ë ¥" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">ìŠ¤íŠ¸ë¦¬ë¨¸ í˜ë¥´ì†Œë‚˜</label>
                            <textarea id="user-persona" placeholder="ì˜ˆ: ì¹œê·¼í•˜ê³  í™œë°œí•œ ê²Œì„ ìŠ¤íŠ¸ë¦¬ë¨¸" rows="2" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500"></textarea>
                            <p class="text-xs text-gray-500 mt-1">AIê°€ ë‹¹ì‹ ì˜ ì„±ê²©ì„ ë°˜ì˜í•œ ë‹µë³€ì„ ìƒì„±í•©ë‹ˆë‹¤</p>
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">í‹±í†¡ ID</label>
                            <div id="tiktok-id-display" class="hidden">
                                <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border border-gray-200">
                                    <div class="flex items-center space-x-3">
                                        <i class="fab fa-tiktok text-2xl"></i>
                                        <div>
                                            <p class="font-semibold text-gray-800" id="display-tiktok-id"></p>
                                            <p class="text-sm text-gray-500" id="display-tiktok-nickname"></p>
                                        </div>
                                    </div>
                                    <button onclick="disconnectTikTok()" class="text-red-600 hover:text-red-700 text-sm">
                                        <i class="fas fa-unlink mr-1"></i>ì—°ê²° í•´ì œ
                                    </button>
                                </div>
                            </div>
                            <!-- TikTok ë¡œê·¸ì¸ ë²„íŠ¼ (ì„ì‹œ ìˆ¨ê¹€) -->
                            <div id="tiktok-connect-btn" class="hidden">
                                <button onclick="connectTikTok()" class="w-full px-4 py-3 bg-black text-white rounded-lg hover:bg-gray-800 transition flex items-center justify-center space-x-2">
                                    <i class="fab fa-tiktok text-xl"></i>
                                    <span>TikTok ì•„ì´ë”” ë“±ë¡</span>
                                </button>
                                <p class="text-xs text-gray-500 mt-2">TikTok ê³„ì •ìœ¼ë¡œ ë¡œê·¸ì¸í•˜ì—¬ ìë™ìœ¼ë¡œ ë“±ë¡í•˜ì„¸ìš”</p>
                            </div>
                            
                            <!-- TikTok ID ìˆ˜ë™ ì…ë ¥ (ì„ì‹œ) -->
                            <div id="tiktok-manual-input" class="block">
                                <div class="flex gap-2">
                                    <input type="text" id="manual-tiktok-id" placeholder="TikTok ID ì…ë ¥ (ì˜ˆ: aoqrhtm)" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-purple-500 focus:border-transparent">
                                    <button onclick="saveTikTokId()" class="px-6 py-3 bg-purple-600 text-white rounded-lg hover:bg-purple-700 transition">
                                        <i class="fas fa-save mr-1"></i>ì €ì¥
                                    </button>
                                </div>
                                <p class="text-xs text-gray-500 mt-2">@ ê¸°í˜¸ ì—†ì´ TikTok IDë§Œ ì…ë ¥í•˜ì„¸ìš”</p>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-language mr-2 text-purple-600"></i>
                        ì–¸ì–´ ì„¤ì •
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">í‘œì‹œ ì–¸ì–´</label>
                            <select id="user-language" class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500">
                                <option value="ko">ğŸ‡°ğŸ‡· í•œêµ­ì–´ (Korean)</option>
                                <option value="en">ğŸ‡ºğŸ‡¸ ì˜ì–´ (English)</option>
                                <option value="ja">ğŸ‡¯ğŸ‡µ ì¼ë³¸ì–´ (Japanese)</option>
                                <option value="es">ğŸ‡ªğŸ‡¸ ìŠ¤í˜ì¸ì–´ (Spanish)</option>
                                <option value="zh-TW">ğŸ‡¹ğŸ‡¼ ì¤‘êµ­ì–´ (Chinese)</option>
                                <option value="vi">ğŸ‡»ğŸ‡³ ë² íŠ¸ë‚¨ì–´ (Vietnamese)</option>
                                <option value="th">ğŸ‡¹ğŸ‡­ íƒœêµ­ì–´ (Thai)</option>
                            </select>
                            <p class="text-xs text-gray-500 mt-2">ì„ íƒí•œ ì–¸ì–´ë¡œ ëª¨ë“  í˜ì´ì§€ê°€ í‘œì‹œë©ë‹ˆë‹¤</p>
                        </div>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-bell mr-2 text-yellow-600"></i>
                        ì•Œë¦¼ ì„¤ì •
                    </h3>
                    <div class="space-y-3">
                        <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-700">ì‹ ì²­ê³¡ ì•Œë¦¼</span>
                            <input type="checkbox" class="toggle" checked>
                        </label>
                        <label class="flex items-center justify-between p-3 bg-gray-50 rounded-lg">
                            <span class="text-sm text-gray-700">ì´ë©”ì¼ ì•Œë¦¼</span>
                            <input type="checkbox" class="toggle">
                        </label>
                    </div>
                </div>

                <div class="bg-white rounded-lg shadow-md p-6">
                    <h3 class="text-xl font-semibold text-gray-800 mb-4 flex items-center">
                        <i class="fas fa-shield-alt mr-2 text-green-600"></i>
                        ë³´ì•ˆ
                    </h3>
                    <button class="w-full px-4 py-3 bg-gray-100 text-gray-700 rounded-lg hover:bg-gray-200 transition text-left">
                        <i class="fas fa-key mr-2"></i>ë¹„ë°€ë²ˆí˜¸ ë³€ê²½
                    </button>
                </div>

                <div class="flex justify-end space-x-4">
                    <button onclick="window.location.reload()" class="px-6 py-3 border border-gray-300 rounded-lg text-gray-700 hover:bg-gray-50 transition">
                        ì·¨ì†Œ
                    </button>
                    <button id="save-settings-btn" class="px-6 py-3 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition">
                        <i class="fas fa-save mr-2"></i>ì €ì¥
                    </button>
                </div>
            </div>
        </div>
    </main>

    <script src="/js/i18n.js"></script>
    <script src="/js/layout.js"></script>
    <script>
        // TikTok ì—°ê²°
        function connectTikTok() {
            const width = 500;
            const height = 600;
            const left = (screen.width - width) / 2;
            const top = (screen.height - height) / 2;
            
            const authWindow = window.open(
                '/auth/tiktok',
                'TikTok Login',
                `width=${width},height=${height},left=${left},top=${top}`
            );
            
            // ë¡œê·¸ì¸ ì™„ë£Œ í™•ì¸
            const checkInterval = setInterval(() => {
                if (authWindow.closed) {
                    clearInterval(checkInterval);
                    // ì‚¬ìš©ì ì •ë³´ ë‹¤ì‹œ ë¡œë“œ
                    loadUserInfo();
                }
            }, 1000);
        }
        
        // TikTok ID ìˆ˜ë™ ì €ì¥
        async function saveTikTokId() {
            const tiktokId = document.getElementById('manual-tiktok-id').value.trim();
            
            if (!tiktokId) {
                alert('TikTok IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            // @ ê¸°í˜¸ ì œê±°
            const cleanId = tiktokId.replace('@', '');
            
            try {
                const response = await fetch('/api/update-profile', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({
                        nickname: document.getElementById('user-nickname').value,
                        tiktokId: cleanId
                    })
                });
                
                const data = await response.json();
                
                if (data.success) {
                    alert('TikTok IDê°€ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                    loadUserInfo();
                } else {
                    alert(data.message || 'ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('TikTok ID ì €ì¥ ì‹¤íŒ¨:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }
        
        // TikTok ì—°ê²° í•´ì œ
        async function disconnectTikTok() {
            if (!confirm('TikTok ê³„ì • ì—°ê²°ì„ í•´ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
                return;
            }
            
            try {
                const response = await fetch('/api/disconnect-tiktok', {
                    method: 'POST'
                });
                
                if (response.ok) {
                    alert('TikTok ê³„ì • ì—°ê²°ì´ í•´ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
                    loadUserInfo();
                } else {
                    alert('ì—°ê²° í•´ì œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('TikTok ì—°ê²° í•´ì œ ì‹¤íŒ¨:', error);
                alert('ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            }
        }

        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/current_user');
                const data = await response.json();
                
                if (data.success && data.user) {
                    document.getElementById('user-email').value = data.user.email;
                    document.getElementById('user-nickname').value = data.user.nickname || '';
                    document.getElementById('user-persona').value = data.user.streamerPersona || '';
                    
                    // TikTok ID í‘œì‹œ
                    if (data.user.tiktokId) {
                        document.getElementById('display-tiktok-id').textContent = '@' + data.user.tiktokId;
                        document.getElementById('display-tiktok-nickname').textContent = data.user.nickname || '';
                        document.getElementById('tiktok-id-display').classList.remove('hidden');
                        document.getElementById('tiktok-connect-btn').classList.add('hidden');
                        document.getElementById('tiktok-manual-input').classList.add('hidden');
                    } else {
                        document.getElementById('tiktok-id-display').classList.add('hidden');
                        document.getElementById('tiktok-connect-btn').classList.add('hidden');
                        document.getElementById('tiktok-manual-input').classList.remove('hidden');
                    }
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
            }
        }

        // ì„¤ì • ì €ì¥
        async function saveSettings() {
            const nickname = document.getElementById('user-nickname').value.trim();
            const persona = document.getElementById('user-persona').value.trim();
            const language = document.getElementById('user-language').value;
            
            if (!nickname) {
                alert('ë‹‰ë„¤ì„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            const btn = document.getElementById('save-settings-btn');
            btn.disabled = true;
            btn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>ì €ì¥ ì¤‘...';
            
            try {
                // í”„ë¡œí•„ ì •ë³´ ì €ì¥ (ë‹‰ë„¤ì„, í˜ë¥´ì†Œë‚˜)
                const profileResponse = await fetch('/api/update-profile', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        nickname,
                        streamerPersona: persona
                    })
                });
                
                // ì–¸ì–´ ì„¤ì • ì €ì¥
                const langResponse = await fetch('/api/update-language', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ language })
                });
                
                if (profileResponse.ok && langResponse.ok) {
                    localStorage.setItem('tikfind_lang', language);
                    alert('ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
                    location.reload();
                } else {
                    const profileData = await profileResponse.json();
                    const langData = await langResponse.json();
                    alert(profileData.message || langData.message || 'ì„¤ì • ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
                }
            } catch (error) {
                console.error('ì„¤ì • ì €ì¥ ì‹¤íŒ¨:', error);
                alert('ì„¤ì • ì €ì¥ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
            } finally {
                btn.disabled = false;
                btn.innerHTML = '<i class="fas fa-save mr-2"></i>ì €ì¥';
            }
        }

        // í˜ì´ì§€ ë¡œë“œ ì‹œ
        document.addEventListener('DOMContentLoaded', async () => {
            // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
            await loadUserInfo();
            
            // í˜„ì¬ ì–¸ì–´ ì„¤ì • ë¡œë“œ
            const currentLang = localStorage.getItem('tikfind_lang') || 'ko';
            document.getElementById('user-language').value = currentLang;
            
            // ì €ì¥ ë²„íŠ¼ ì´ë²¤íŠ¸
            document.getElementById('save-settings-btn').addEventListener('click', saveSettings);
        });
    </script>
</body>
</html>
