<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TikFind - ë°©ì†¡ ì‹œì‘</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- YouTube IFrame Player API -->
    <script src="https://www.youtube.com/iframe_api"></script>
    <link rel="stylesheet" href="/css/desktop-app.css">
    <link rel="stylesheet" href="/css/ai-assistant.css">
    <script src="/socket.io/socket.io.js"></script>
</head>
<body class="bg-slate-900 min-h-screen">
    <div id="sidebar-container"></div>
    <div id="header-container"></div>
    
    <main class="ml-64 mt-16 p-8">
        <div class="max-w-full mx-auto">
            <div class="container" style="max-height: none; overflow: visible;">
            <!-- í—¤ë” -->
            <div class="header">
                <div class="header-content">
                    <img src="/images/logo.png" alt="TikFind Logo" class="logo">
                    <div class="header-info">
                        <span class="header-title">í‹±í†¡ë¼ì´ë¸Œë„ìš°ë¯¸</span>
                        <div style="display: flex; align-items: center; gap: 8px;">
                            <span class="plan-badge" id="planBadge">FREE</span>
                            <span class="language-badge" id="languageBadge" style="padding: 4px 12px; font-size: 11px; background: rgba(102, 126, 234, 0.2); color: #667eea; border: 1px solid #667eea; border-radius: 12px; font-weight: 600;">ğŸŒ í•œêµ­ì–´</span>
                            <button id="upgradePlanBtn" class="btn-upgrade" style="display: none; padding: 4px 12px; font-size: 11px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 12px; cursor: pointer;">ì—…ê·¸ë ˆì´ë“œ</button>
                        </div>
                    </div>
                </div>
                <div id="planUsageInfo" style="display: none; margin-top: 8px; padding: 8px 12px; background: rgba(102, 126, 234, 0.1); border-radius: 8px; font-size: 11px;">
                    <div style="display: flex; align-items: center; gap: 16px; flex-wrap: wrap;">
                        <span style="display: flex; align-items: center; gap: 4px;">
                            ğŸ¯ AI ë°œìŒ ì½”ì¹˜: <span id="aiCoachUsage">0/10</span>
                        </span>
                        <span style="display: flex; align-items: center; gap: 4px;">
                            ğŸµ ì‹ ì²­ê³¡: <span id="songRequestUsage">0/5</span>
                        </span>
                        <span style="display: flex; align-items: center; gap: 4px;">
                            ğŸ¤– GPT AI: <span id="gptAiUsage">0/3</span>
                        </span>
                        <button id="usageLimitUpgradeBtn" style="display: none; padding: 4px 12px; font-size: 11px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); color: white; border: none; border-radius: 12px; cursor: pointer; font-weight: bold; margin-left: auto;">
                            âš ï¸ ì—…ê·¸ë ˆì´ë“œ
                        </button>
                    </div>
                </div>
            </div>

            <!-- ë©”ì¸ ë ˆì´ì•„ì›ƒ (2x2 ê·¸ë¦¬ë“œ) -->
            <div class="main-layout-grid" style="display: grid; grid-template-columns: 3fr 7fr; gap: 16px; margin-bottom: 20px;">
                <!-- ì¢Œì¸¡ ì „ì²´: ì‹ ì²­ê³¡ í -->
                <div class="grid-item" style="grid-row: 1 / 3; background: #1a1a1a; padding: 16px; border-radius: 8px;">
                    <div class="song-queue-section-compact" style="height: 100%; display: flex; flex-direction: column;">
                        <!-- ì—°ê²° ì„¤ì • (ìƒë‹¨) -->
                        <div class="connection-section-compact" style="margin-bottom: 12px;">
                            <div style="display: flex; gap: 4px; margin-bottom: 6px; align-items: center;">
                                <div style="display: flex; flex-direction: column; flex: 1; min-width: 0;">
                                    <label style="font-size: 10px; color: #666; margin-bottom: 2px;">User ID</label>
                                    <input 
                                        type="text" 
                                        id="userId" 
                                        placeholder="User ID"
                                        autocomplete="off"
                                        class="input-compact"
                                        style="width: 100%;"
                                        readonly
                                    >
                                </div>
                                <div style="display: flex; flex-direction: column; flex: 1; min-width: 0;">
                                    <label style="font-size: 10px; color: #666; margin-bottom: 2px;">TikTok ID</label>
                                    <input 
                                        type="text" 
                                        id="username" 
                                        placeholder="TikTok ID"
                                        autocomplete="off"
                                        class="input-compact"
                                        style="width: 100%;"
                                        readonly
                                    >
                                </div>
                                <button id="startBtn" class="btn-compact btn-primary" style="padding: 4px 12px; font-size: 11px; margin-top: 16px;">ì‹œì‘</button>
                                <button id="stopBtn" class="btn-compact btn-danger" disabled style="padding: 4px 12px; font-size: 11px; margin-top: 16px;">ì¤‘ì§€</button>
                            </div>
                            
                            <div style="display: flex; align-items: center; gap: 12px; margin-bottom: 8px; font-size: 12px;">
                                <div class="status-compact" style="margin: 0;">
                                    <span class="status-dot" id="statusDot"></span>
                                    <span id="statusText">ì—°ê²° ì•ˆ ë¨</span>
                                </div>
                                <div style="display: flex; gap: 8px; color: #666;">
                                    <span>ğŸ‘¥ <span id="viewerCount">0</span></span>
                                    <span>ğŸ’¬ <span id="messageCount">0</span></span>
                                    <span>ğŸ <span id="giftCount">0</span></span>
                                    <span>â¤ï¸ <span id="likeCount">0</span></span>
                                </div>
                            </div>
                            
                            <div class="tts-compact" style="display: grid; grid-template-columns: 1fr 1fr; gap: 8px; padding: 6px 8px; background: #1a1a1a; border-radius: 4px;">
                                <label class="tts-label-compact" style="display: flex; align-items: center; gap: 4px; margin: 0;">
                                    <input type="checkbox" id="ttsEnabled" checked>
                                    <span style="font-size: 10px; color: #fff;">ì±„íŒ…ì„ ìŒì„±ìœ¼ë¡œ ì•ˆë‚´</span>
                                </label>
                                <div style="display: flex; align-items: center; gap: 6px; justify-content: flex-end;">
                                    <span style="font-size: 9px; color: #999;">ì†ë„</span>
                                    <input type="range" id="ttsSpeed" min="0.5" max="2.0" step="0.1" value="1.0" style="width: 70px;">
                                    <span id="ttsSpeedValue" style="font-size: 9px; color: #999; min-width: 30px;">1.0x</span>
                                </div>
                            </div>
                            
                            <!-- ì‹œì²­ì ì‹ ì²­ê³¡ ì•ˆë‚´ -->
                            <div style="display: flex; align-items: center; gap: 8px; padding: 6px 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 4px; margin-top: 8px;">
                                <i class="fas fa-music" style="color: white; font-size: 12px;"></i>
                                <span style="font-size: 10px; color: white; flex: 1;">ì‹ ì²­ê³¡ ì‹ ì²­ì€ #ë…¸ë˜ì œëª©#ê°€ìˆ˜ì´ë¦„ ì±„íŒ…ì°½ì— ë‚¨ê²¨ì£¼ì„¸ìš”.</span>
                                <button id="copyGuideBtn" onclick="copyRequestGuide()" style="padding: 4px 8px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 4px; font-size: 9px; cursor: pointer; transition: all 0.2s;">
                                    <i class="fas fa-copy" style="margin-right: 2px;"></i>ë³µì‚¬
                                </button>
                            </div>
                        </div>
                        
                        <!-- AI ìë™ì¬ìƒ ì„¹ì…˜ -->
                        <div style="margin-bottom: 12px; padding: 8px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); border-radius: 8px;">
                            <div style="display: flex; gap: 6px; align-items: center; margin-bottom: 6px;">
                                <select id="genreSelect" style="padding: 4px 8px; font-size: 10px; background: rgba(0,0,0,0.3); color: white; border: 1px solid rgba(255,255,255,0.2); border-radius: 4px; flex: 1;">
                                    <option value="" disabled selected>AIì¬ìƒì¥ë¥´ì„ íƒ</option>
                                </select>
                                <button id="aiAutoPlayBtn" class="btn-toolbar" style="background: rgba(255,255,255,0.2); color: white; padding: 4px 10px; font-size: 10px; border: 1px solid rgba(255,255,255,0.3);">
                                    <i class="fas fa-robot" style="margin-right: 2px;"></i>AI ìë™ì¬ìƒ
                                </button>
                                <button id="aiAutoPlayStopBtn" class="btn-toolbar" style="background: #dc2626; color: white; padding: 4px 10px; font-size: 10px; display: none;">
                                    <i class="fas fa-stop" style="margin-right: 2px;"></i>ë©ˆì¶¤
                                </button>
                            </div>
                            <div id="aiCurrentSong" style="display: none; padding: 6px 8px; background: rgba(0,0,0,0.3); border-radius: 4px; font-size: 11px; color: white;">
                                <div style="display: flex; align-items: center; gap: 8px;">
                                    <i class="fas fa-music" style="color: #a78bfa;"></i>
                                    <span id="aiSongTitle" style="flex: 1;">-</span>
                                    <button onclick="skipAISong()" style="padding: 2px 6px; background: rgba(255,255,255,0.2); color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer;">
                                        <i class="fas fa-forward"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- ì‹ ì²­ê³¡ í í—¤ë” -->
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                            <h3 class="section-title" style="margin: 0;">ğŸµ ì‹ ì²­ê³¡ í</h3>
                        </div>
                        
                        <!-- ì‹ ì²­ê³¡ ì„¤ì • -->
                        <div style="display: flex; gap: 8px; align-items: center; margin-bottom: 8px; padding: 6px; background: #0a0a0a; border-radius: 6px; flex-wrap: wrap;">
                            <span style="font-size: 10px; color: #999;">ì‹ ì²­ê³¡:</span>
                            <select id="requestAcceptSelect" style="padding: 3px 6px; font-size: 10px; background: #1a1a1a; color: white; border: 1px solid #333; border-radius: 4px;">
                                <option value="accept">ë°›ê¸°</option>
                                <option value="reject">ì•ˆë°›ê¸°</option>
                            </select>
                            <span style="font-size: 10px; color: #999;">ì¤‘ë³µì‹ ì²­ì œí•œ:</span>
                            <select id="requestCooldown" style="padding: 3px 6px; font-size: 10px; background: #1a1a1a; color: white; border: 1px solid #333; border-radius: 4px;">
                                <option value="0">ì œí•œì—†ìŒ</option>
                                <option value="10">10ë¶„ì— 1ê³¡ ê°€ëŠ¥</option>
                                <option value="20">20ë¶„ì— 1ê³¡ ê°€ëŠ¥</option>
                                <option value="30" selected>30ë¶„ì— 1ê³¡ ê°€ëŠ¥</option>
                            </select>
                            <label style="display: flex; align-items: center; gap: 4px; font-size: 10px; color: #999; margin-left: auto;">
                                <input type="checkbox" id="autoSkipAbsent" checked style="width: 14px; height: 14px;">
                                <span>ë¶€ì¬ì ìë™íŒ¨ìŠ¤</span>
                            </label>
                        </div>
                        
                        
                        <!-- ì‹ ì²­ê³¡ ê´€ë¦¬ íˆ´ë°” -->
                        <div class="song-toolbar">
                            <div class="toolbar-left">
                                <span class="song-count" id="songCount">ì´ 0ê³¡</span>
                            </div>
                            <div class="toolbar-right" style="display: flex; gap: 6px;">
                                <button id="nextSongBtn" class="btn-toolbar" style="background: #2563eb; color: white; padding: 4px 10px; font-size: 10px;">
                                    <i class="fas fa-forward" style="margin-right: 2px;"></i>ë‹¤ìŒê³¡
                                </button>
                                <button id="pausePlayBtn" class="btn-toolbar" style="background: #f59e0b; color: white; padding: 4px 10px; font-size: 10px;">
                                    <i class="fas fa-pause" style="margin-right: 2px;"></i>ì¼ì‹œì •ì§€
                                </button>
                                <button class="btn-toolbar" onclick="clearAllSongs()" title="ì „ì²´ ì‚­ì œ">ğŸ—‘ï¸ ì „ì²´ì‚­ì œ</button>
                            </div>
                        </div>
                        
                        <!-- ìŠ¤íŠ¸ë¦¬ë¨¸ ì‹ ì²­ê³¡ ì¶”ê°€ -->
                        <div class="streamer-add-song" style="display: flex; gap: 8px; margin-bottom: 12px;">
                            <input type="text" id="streamerSongTitle" placeholder="ë…¸ë˜ ì œëª© (ì˜ˆ: Dynamite)" class="song-input" style="flex: 2;">
                            <input type="text" id="streamerSongArtist" placeholder="ê°€ìˆ˜ (ì˜ˆ: BTS)" class="song-input" style="flex: 1;">
                            <button id="streamerAddBtn" class="btn-add-song" onclick="streamerAddSong()">ğŸ” ê²€ìƒ‰ & ì¶”ê°€</button>
                        </div>
                        
                        <!-- ì‹ ì²­ê³¡ ë¦¬ìŠ¤íŠ¸ -->
                        <div class="song-queue-list" id="songQueueList" style="flex: 1; overflow-y: auto; max-height: 250px; margin-bottom: 8px;">
                            <p class="empty-message">ì‹ ì²­ê³¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</p>
                        </div>
                        
                        <!-- YouTube í”Œë ˆì´ì–´ (ì¶•ì†Œ) -->
                        <div style="background: #0a0a0a; border-radius: 8px; overflow: hidden;">
                            <div id="youtubePlayer" style="height: 180px; background: #000; display: flex; align-items: center; justify-content: center;">
                                <p style="color: #666; font-size: 11px;">ì‹ ì²­ê³¡ì´ ì—†ìŠµë‹ˆë‹¤</p>
                            </div>
                            <div id="nowPlaying" style="padding: 8px; border-top: 1px solid #222; display: none;">
                                <p style="font-size: 9px; color: #666; margin: 0 0 2px 0;">ì¬ìƒ ì¤‘</p>
                                <p id="currentSongTitle" style="font-size: 11px; font-weight: 600; color: white; margin: 0 0 2px 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">-</p>
                                <p style="font-size: 9px; color: #666; margin: 0;">ì‹ ì²­: <span id="currentRequester">-</span></p>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI ë°œìŒ ì½”ì¹˜ -->
                <div class="grid-item" style="background: #1a1a1a; padding: 16px; border-radius: 8px;">
                    <div class="chat-ai-integrated">
                        <h3 class="section-title">ğŸ’¬ ì‹¤ì‹œê°„ ì±„íŒ… + ğŸ¤– AI ë°œìŒ ì½”ì¹˜</h3>
                        <div style="display: flex; gap: 10px; height: 750px;">
                            <!-- ì™¼ìª½ 30%: ì „ì²´ ì±„íŒ… -->
                            <div style="width: 30%; display: flex; flex-direction: column;">
                                <h4 style="font-size: 12px; color: #999; margin-bottom: 8px; padding: 0 8px;">ğŸ’¬ ì „ì²´ ì±„íŒ…</h4>
                                <div id="nativeLanguageMessages" style="height: 720px; overflow-y: auto; padding: 8px; background: #0a0a0a; border-radius: 4px; border: 1px solid #333;">
                                    <p class="empty-message" style="font-size: 11px;">ëª¨ë“  ì±„íŒ…ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤</p>
                                </div>
                            </div>
                            <!-- ì˜¤ë¥¸ìª½ 70%: AI ë°œìŒ ì½”ì¹˜ -->
                            <div style="width: 70%; display: flex; flex-direction: column;">
                                <h4 style="font-size: 12px; color: #999; margin-bottom: 8px; padding: 0 8px;">ğŸ¤– AI ë°œìŒ ì½”ì¹˜</h4>
                                <div id="foreignLanguageMessages" style="height: 720px; overflow-y: auto; padding: 8px; background: #0a0a0a; border-radius: 4px; border: 1px solid #333;">
                                    <p class="empty-message" style="font-size: 11px;">ì™¸êµ­ì–´ ì±„íŒ… ì‹œ AI ë°œìŒ ì½”ì¹˜ê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- AI ì–´ì‹œìŠ¤í„´íŠ¸ -->
                <div class="bg-slate-800 rounded-lg shadow-md p-6">
                    <div class="ai-assistant">
                        <div class="ai-assistant-header">
                            <span>ğŸ¤– AI ì–´ì‹œìŠ¤í„´íŠ¸</span>
                            <span class="ai-usage" id="aiUsage">0/20</span>
                        </div>
                        <div class="ai-chat-history" id="aiChatHistory">
                            <p class="empty-message">ë°©ì†¡ ì¤‘ ê¶ê¸ˆí•œ ê²ƒì„ ë¬¼ì–´ë³´ì„¸ìš”!</p>
                        </div>
                        <div class="ai-input-area">
                            <input type="text" id="aiQuestion" placeholder="ì§ˆë¬¸ì„ ì…ë ¥í•˜ì„¸ìš”..." class="ai-input" maxlength="200">
                            <button id="aiSendBtn" class="ai-send-btn">ì „ì†¡</button>
                        </div>
                    </div>
                </div>

            </div>
            <!-- ë©”ì¸ ë ˆì´ì•„ì›ƒ ë -->
            </div>
        </div>
    </main>

    <!-- í‘¸í„° -->
    <footer class="ml-64 bg-slate-800 text-white py-3 px-8 border-t border-slate-700">
        <div class="max-w-full mx-auto text-center">
            <p class="text-sm text-gray-400">TikFind v1.0.7</p>
        </div>
    </footer>

    <!-- Desktop App ì•ˆë‚´ ëª¨ë‹¬ -->
    <div id="desktopAppModal" style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 9999; align-items: center; justify-content: center;">
        <div style="background: white; padding: 32px; border-radius: 16px; max-width: 600px; text-align: left;">
            <h2 style="color: #333; margin-bottom: 16px; text-align: center;">âš ï¸ Desktop Appì´ ì‹¤í–‰ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤</h2>
            <p style="color: #666; margin-bottom: 24px; line-height: 1.6; text-align: center;">
                TikTok Live ë°ì´í„°ë¥¼ ìˆ˜ì§‘í•˜ë ¤ë©´ Desktop Appì´ ì‹¤í–‰ë˜ì–´ ìˆì–´ì•¼ í•©ë‹ˆë‹¤.
            </p>
            
            <div style="background: #f8f9fa; padding: 16px; border-radius: 8px; margin-bottom: 24px;">
                <h3 style="color: #333; font-size: 14px; margin-bottom: 12px;">ğŸ“‹ Desktop App ì‹¤í–‰ ë°©ë²•:</h3>
                <ol style="color: #666; font-size: 14px; line-height: 1.8; margin-left: 20px;">
                    <li>ë‹¤ìš´ë¡œë“œí•œ <strong>TikFind Setup.exe</strong> íŒŒì¼ì„ ì‹¤í–‰</li>
                    <li>ì„¤ì¹˜ ì™„ë£Œ í›„ ìë™ìœ¼ë¡œ Desktop App ì‹¤í–‰ë¨</li>
                    <li>ì‹œìŠ¤í…œ íŠ¸ë ˆì´(í™”ë©´ ì˜¤ë¥¸ìª½ í•˜ë‹¨)ì— TikFind ì•„ì´ì½˜ í™•ì¸</li>
                    <li>ì´ í˜ì´ì§€ì—ì„œ <strong>"ì‹œì‘"</strong> ë²„íŠ¼ í´ë¦­</li>
                </ol>
                <p style="color: #999; font-size: 12px; margin-top: 12px; margin-bottom: 0;">
                    ğŸ’¡ PC ì¬ë¶€íŒ… ì‹œì—ë„ Desktop Appì´ ìë™ìœ¼ë¡œ ì‹¤í–‰ë©ë‹ˆë‹¤.
                </p>
            </div>
            
            <div style="display: flex; flex-direction: column; gap: 12px;">
                <button onclick="closeModal()" style="padding: 12px 24px; background: #667eea; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px;">
                    âœ… í™•ì¸ (Desktop App ì‹¤í–‰ í›„ ë‹¤ì‹œ ì‹œë„)
                </button>
                <a id="downloadAppLink" href="/api/desktop-app/download" style="padding: 12px 24px; background: #10b981; color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; text-decoration: none; display: block; text-align: center;">
                    ğŸ“¥ Desktop App ë‹¤ìš´ë¡œë“œ
                </a>
            </div>
        </div>
    </div>

    <script src="/js/i18n.js"></script>
    <script src="/js/layout.js"></script>
    <script>
        const socket = io();
        let currentUser = null;
        let messageCount = 0;
        let viewerCount = 0;
        let giftCount = 0;
        let likeCount = 0;
        let processedMessageIds = new Set();
        let limitExceededShown = false;
        let desktopAppConnected = false;

        // ì‚¬ìš©ì ì •ë³´ ë¡œë“œ
        async function loadUserInfo() {
            try {
                const response = await fetch('/api/current_user');
                const data = await response.json();
                
                if (data.success && data.user) {
                    currentUser = data.user;
                    const userId = String(currentUser._id || currentUser.id);
                    
                    // í”Œëœ ì œí•œ ì •ë³´ ì €ì¥
                    window.planLimits = data.planLimits || {
                        songRequestLimit: 50,
                        gptAiLimit: -1,
                        pronunciationCoachLimit: 0
                    };
                    
                    console.log('ğŸ’ í”Œëœ ì œí•œ ì •ë³´:', window.planLimits);
                    
                    // User IDì™€ TikTok ID í‘œì‹œ
                    document.getElementById('userId').value = userId;
                    document.getElementById('username').value = currentUser.tiktokId || '';
                    
                    // í”Œëœ ì •ë³´ í‘œì‹œ
                    updatePlanBadge(currentUser.subscription);
                    
                    // ë‹¤ìš´ë¡œë“œ ë§í¬ì— User ID í¬í•¨
                    const downloadLink = document.getElementById('downloadAppLink');
                    if (downloadLink) {
                        downloadLink.href = `/api/desktop-app/download?userId=${userId}`;
                    }
                    
                    console.log('âœ… ì‚¬ìš©ì ë¡œë“œ:', currentUser);
                    
                    // ì„ íƒí•œ ì–¸ì–´ í‘œì‹œ
                    updateLanguageBadge(currentUser.preferredLanguage || 'ko');
                    
                    // ì‚¬ìš©ëŸ‰ ì •ë³´ í‘œì‹œ
                    if (data.usage) {
                        updateUsageDisplay(data.usage);
                        
                        // í•œë„ ì´ˆê³¼ ìƒíƒœ í™•ì¸ ë° ë©”ì‹œì§€ í‘œì‹œ
                        checkAndShowLimitExceeded(data.usage);
                    }
                    
                    // Socketì´ ì´ë¯¸ ì—°ê²°ë˜ì–´ ìˆìœ¼ë©´ join-room í˜¸ì¶œ
                    if (socket.connected) {
                        socket.emit('join-room', userId);
                        console.log('ğŸ‘¤ ì‚¬ìš©ì ë£¸ ì°¸ê°€:', userId);
                    }
                    
                    // ì‹ ì²­ê³¡ í ë³µì›
                    loadSongQueue(userId);
                } else {
                    window.location.href = '/';
                }
            } catch (error) {
                console.error('ì‚¬ìš©ì ì •ë³´ ë¡œë“œ ì‹¤íŒ¨:', error);
                window.location.href = '/';
            }
        }
        
        // ì‚¬ìš©ëŸ‰ í‘œì‹œ ì—…ë°ì´íŠ¸
        function updateUsageDisplay(usage) {
            const aiCoachUsage = document.getElementById('aiCoachUsage');
            const songRequestUsage = document.getElementById('songRequestUsage');
            const gptAiUsage = document.getElementById('gptAiUsage');
            
            if (aiCoachUsage) {
                const limit = usage.pronunciationCoach.limit === -1 ? 'âˆê°œ' : `${usage.pronunciationCoach.limit}ê°œì¤‘`;
                const used = `/${usage.pronunciationCoach.used}ì‚¬ìš©`;
                aiCoachUsage.textContent = `${limit} ${used}`;
                
                // ì œí•œ ì´ˆê³¼ ì‹œ ë¹¨ê°„ìƒ‰ í‘œì‹œ
                if (usage.pronunciationCoach.limit !== -1 && usage.pronunciationCoach.used >= usage.pronunciationCoach.limit) {
                    aiCoachUsage.style.color = '#ef4444';
                    aiCoachUsage.style.fontWeight = 'bold';
                } else {
                    aiCoachUsage.style.color = '';
                    aiCoachUsage.style.fontWeight = '';
                }
            }
            
            if (songRequestUsage) {
                const limit = usage.songRequest.limit === -1 ? 'âˆê°œ' : `${usage.songRequest.limit}ê°œì¤‘`;
                const used = `/${usage.songRequest.used}ì‚¬ìš©`;
                songRequestUsage.textContent = `${limit} ${used}`;
                
                if (usage.songRequest.limit !== -1 && usage.songRequest.used >= usage.songRequest.limit) {
                    songRequestUsage.style.color = '#ef4444';
                    songRequestUsage.style.fontWeight = 'bold';
                } else {
                    songRequestUsage.style.color = '';
                    songRequestUsage.style.fontWeight = '';
                }
            }
            
            if (gptAiUsage) {
                const limit = usage.gptAi.limit === -1 ? 'âˆê°œ' : `${usage.gptAi.limit}ê°œì¤‘`;
                const used = `/${usage.gptAi.used}ì‚¬ìš©`;
                gptAiUsage.textContent = `${limit} ${used}`;
                
                if (usage.gptAi.limit !== -1 && usage.gptAi.used >= usage.gptAi.limit) {
                    gptAiUsage.style.color = '#ef4444';
                    gptAiUsage.style.fontWeight = 'bold';
                } else {
                    gptAiUsage.style.color = '';
                    gptAiUsage.style.fontWeight = '';
                }
            }
            
            // í”Œëœ ì‚¬ìš©ëŸ‰ ì •ë³´ í•­ìƒ í‘œì‹œ
            const planUsageInfo = document.getElementById('planUsageInfo');
            if (planUsageInfo) {
                planUsageInfo.style.display = 'block';
            }
            
            // ì‚¬ìš©ëŸ‰ ì´ˆê³¼ ì‹œ ì—…ê·¸ë ˆì´ë“œ ë²„íŠ¼ í‘œì‹œ
            const usageLimitUpgradeBtn = document.getElementById('usageLimitUpgradeBtn');
            const isAnyLimitReached = 
                (usage.pronunciationCoach.limit !== -1 && usage.pronunciationCoach.used >= usage.pronunciationCoach.limit) ||
                (usage.songRequest.limit !== -1 && usage.songRequest.used >= usage.songRequest.limit) ||
                (usage.gptAi.limit !== -1 && usage.gptAi.used >= usage.gptAi.limit);
            
            if (usageLimitUpgradeBtn && isAnyLimitReached) {
                usageLimitUpgradeBtn.style.display = 'block';
                usageLimitUpgradeBtn.onclick = () => {
                    window.location.href = '/pricing';
                };
            } else if (usageLimitUpgradeBtn) {
                usageLimitUpgradeBtn.style.display = 'none';
            }
        }

        // í”Œëœ ë±ƒì§€ ì—…ë°ì´íŠ¸
        function updatePlanBadge(subscription) {
            const planBadge = document.getElementById('planBadge');
            const upgradePlanBtn = document.getElementById('upgradePlanBtn');
            const planUsageInfo = document.getElementById('planUsageInfo');
            
            if (!subscription || subscription.plan === 'free') {
                planBadge.textContent = 'FREE';
                planBadge.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
                upgradePlanBtn.style.display = 'inline-block';
            } else if (subscription.plan === 'trial') {
                planBadge.textContent = 'TRIAL';
                planBadge.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
                planUsageInfo.style.display = 'block';
                upgradePlanBtn.style.display = 'inline-block';
            } else if (subscription.plan === 'pro') {
                planBadge.textContent = 'PRO';
                planBadge.style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
                upgradePlanBtn.style.display = 'none';
            }
        }
        
        // ì–¸ì–´ ë±ƒì§€ ì—…ë°ì´íŠ¸
        function updateLanguageBadge(languageCode) {
            const languageBadge = document.getElementById('languageBadge');
            const languageNames = {
                'ko': 'í•œêµ­ì–´',
                'en': 'English',
                'ja': 'æ—¥æœ¬èª',
                'zh': 'ä¸­æ–‡',
                'es': 'EspaÃ±ol',
                'fr': 'FranÃ§ais',
                'de': 'Deutsch',
                'pt': 'PortuguÃªs',
                'ru': 'Ğ ÑƒÑÑĞºĞ¸Ğ¹',
                'ar': 'Ø§Ù„Ø¹Ø±Ø¨ÙŠØ©',
                'hi': 'à¤¹à¤¿à¤¨à¥à¤¦à¥€',
                'th': 'à¹„à¸—à¸¢',
                'vi': 'Tiáº¿ng Viá»‡t',
                'id': 'Bahasa Indonesia'
            };
            
            const languageName = languageNames[languageCode] || languageCode.toUpperCase();
            languageBadge.textContent = `ğŸŒ ${languageName}`;
        }

        // ëª¨ë‹¬ ì œì–´
        function showDesktopAppModal() {
            const modal = document.getElementById('desktopAppModal');
            modal.style.display = 'flex';
        }

        function closeModal() {
            const modal = document.getElementById('desktopAppModal');
            modal.style.display = 'none';
        }

        // Socket.io ì—°ê²°
        socket.on('connect', () => {
            console.log('âœ… Socket.io ì—°ê²°');
            
            if (currentUser) {
                const userId = String(currentUser._id || currentUser.id);
                socket.emit('join-room', userId);
                
                // ì €ì¥ëœ ë¼ì´ë¸Œ ìƒíƒœ ë³µì›
                const savedLiveState = localStorage.getItem('tikfind_live_state');
                if (savedLiveState === 'true') {
                    // ì„œë²„ì— í˜„ì¬ ìƒíƒœ ìš”ì²­
                    socket.emit('get-live-status', { userId });
                }
            }
        });

        socket.on('disconnect', () => {
            console.log('âŒ Socket.io ì—°ê²° ëŠê¹€');
            updateStatus('ì—°ê²° ëŠê¹€', false);
        });

        // Desktop App ì—°ê²° ìƒíƒœ
        socket.on('desktop-app-connected', (data) => {
            desktopAppConnected = true;
            console.log('âœ… Desktop App ì—°ê²°ë¨');
        });

        socket.on('desktop-app-disconnected', (data) => {
            desktopAppConnected = false;
            console.log('âŒ Desktop App ì—°ê²° ëŠê¹€');
            if (isLive) {
                updateStatus('Desktop App ì—°ê²° ëŠê¹€', false);
            }
        });

        // ë¼ì´ë¸Œ ìƒíƒœ
        socket.on('live-status', (data) => {
            console.log('ğŸ“± live-status ìˆ˜ì‹ :', data);
            isLive = data.isLive;
            localStorage.setItem('tikfind_live_state', isLive ? 'true' : 'false');
            
            if (data.isLive) {
                desktopAppConnected = true;
                updateStatus('ë°©ì†¡ ì¤‘', true);
                document.getElementById('startBtn').disabled = true;
                document.getElementById('startBtn').textContent = 'ë°©ì†¡ ì¤‘';
                document.getElementById('stopBtn').disabled = false;
            } else {
                updateStatus('ì—°ê²° ì•ˆ ë¨', false);
                document.getElementById('startBtn').disabled = false;
                document.getElementById('startBtn').textContent = 'ì‹œì‘';
                document.getElementById('stopBtn').disabled = true;
            }
        });

        // ì‹œì²­ì ìˆ˜
        socket.on('viewer-update', (data) => {
            document.getElementById('viewerCount').textContent = data.viewerCount || 0;
        });

        // ì±„íŒ… ë©”ì‹œì§€
        socket.on('chat-message', (data) => {
            // ì¤‘ë³µ ë©”ì‹œì§€ ë°©ì§€
            const messageId = `${data.username}_${data.message}_${data.timestamp}`;
            if (processedMessageIds.has(messageId)) {
                console.log('â­ï¸ ì¤‘ë³µ ë©”ì‹œì§€ ìŠ¤í‚µ:', messageId);
                return;
            }
            processedMessageIds.add(messageId);
            
            // ë©”ì‹œì§€ IDê°€ 1000ê°œ ì´ìƒì´ë©´ ì˜¤ë˜ëœ ê²ƒ ì œê±°
            if (processedMessageIds.size > 1000) {
                const firstId = processedMessageIds.values().next().value;
                processedMessageIds.delete(firstId);
            }
            
            messageCount++;
            document.getElementById('messageCount').textContent = messageCount;
            addChatMessage(data);
            
            // ì‹œì²­ì ì¬ì‹¤ ì—¬ë¶€ ì¶”ì 
            if (data.username) {
                currentViewers.add(data.username);
                // ì‹ ì²­ê³¡ í UI ì—…ë°ì´íŠ¸ (ì¬ì‹¤ ì—¬ë¶€ ë°˜ì˜)
                if (currentSongQueue.length > 0) {
                    updateSongQueue(currentSongQueue);
                }
            }
            
            // ì‚¬ìš©ëŸ‰ ì •ë³´ ì‹¤ì‹œê°„ ì—…ë°ì´íŠ¸
            if (data.usage) {
                updateUsageDisplay(data.usage);
            }
        });

        // ì„ ë¬¼
        socket.on('gift-received', (data) => {
            giftCount += data.count || 1;
            document.getElementById('giftCount').textContent = giftCount;
        });

        // ì¢‹ì•„ìš”
        socket.on('like-received', (data) => {
            likeCount += data.count || 1;
            document.getElementById('likeCount').textContent = likeCount;
        });

        // ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateStatus(text, isConnected) {
            const statusText = document.getElementById('statusText');
            const statusDot = document.getElementById('statusDot');
            
            statusText.textContent = text;
            
            if (isConnected) {
                statusDot.style.background = '#10b981';
                statusDot.style.boxShadow = '0 0 8px rgba(16, 185, 129, 0.6)';
            } else {
                statusDot.style.background = '#ef4444';
                statusDot.style.boxShadow = '0 0 8px rgba(239, 68, 68, 0.6)';
            }
        }

        // ì±„íŒ… ë©”ì‹œì§€ ì¶”ê°€
        function addChatMessage(data) {
            console.log('ğŸ“¨ ë©”ì‹œì§€ ìˆ˜ì‹ :', {
                message: data.message,
                messageLanguage: data.messageLanguage,
                preferredLanguage: currentUser?.preferredLanguage,
                hasPronunciationGuide: !!data.pronunciationGuide
            });
            
            // ì™¼ìª½: ëª¨ë“  ì±„íŒ… í‘œì‹œ (ë‚´ ì–¸ì–´ + ì™¸êµ­ì–´)
            const nativeDiv = document.getElementById('nativeLanguageMessages');
            const nativeEmpty = nativeDiv.querySelector('.empty-message');
            if (nativeEmpty) nativeEmpty.remove();
            
            const allMessageEl = document.createElement('div');
            allMessageEl.className = 'chat-message';
            allMessageEl.style.cssText = 'padding: 4px 0; margin-bottom: 6px;';
            allMessageEl.innerHTML = `
                <div>
                    <span style="color: #fff; font-size: 11px;">@${data.username}</span>
                    <span style="color: #999; font-size: 11px; margin: 0 4px;">/</span>
                    <span style="color: #fff; font-size: 11px;">${escapeHtml(data.message)}</span>
                </div>
            `;
            
            nativeDiv.appendChild(allMessageEl);
            nativeDiv.scrollTop = nativeDiv.scrollHeight;
            
            // ì˜¤ë¥¸ìª½: ì™¸êµ­ì–´ AI ë°œìŒ ì½”ì¹˜ë§Œ í‘œì‹œ
            const guide = data.pronunciationGuide;
            if (guide) {
                const foreignDiv = document.getElementById('foreignLanguageMessages');
                const foreignEmpty = foreignDiv.querySelector('.empty-message');
                if (foreignEmpty) foreignEmpty.remove();
                
                const coachMessageEl = document.createElement('div');
                coachMessageEl.className = 'chat-message';
                
                // í•œë„ ì´ˆê³¼ ë©”ì‹œì§€ ì²´í¬
                if (guide.limitExceeded) {
                    // í•œë„ ì´ˆê³¼ ë©”ì‹œì§€ëŠ” í•œ ë²ˆë§Œ í‘œì‹œ
                    if (limitExceededShown) {
                        return;
                    }
                    limitExceededShown = true;
                    
                    coachMessageEl.style.cssText = 'padding: 16px; margin-bottom: 10px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 8px; border: 2px solid #fca5a5;';
                    coachMessageEl.innerHTML = `
                        <div style="text-align: center;">
                            <div style="font-size: 24px; margin-bottom: 8px;">âš ï¸</div>
                            <div style="color: #fff; font-size: 14px; font-weight: bold; margin-bottom: 8px;">
                                ì¼ì¼ AI ë°œìŒ ì½”ì¹˜ í•œë„ ì´ˆê³¼
                            </div>
                            <div style="color: #fee2e2; font-size: 12px; margin-bottom: 12px;">
                                ì˜¤ëŠ˜ ì‚¬ìš©ëŸ‰: ${guide.currentUsage}/${guide.limit}
                            </div>
                            <button onclick="window.location.href='/dashboard/subscription'" style="
                                padding: 8px 16px;
                                background: #fff;
                                color: #dc2626;
                                border: none;
                                border-radius: 6px;
                                font-weight: bold;
                                cursor: pointer;
                                font-size: 13px;
                            ">
                                â¬†ï¸ í”Œëœ ì—…ê·¸ë ˆì´ë“œ
                            </button>
                        </div>
                    `;
                } else {
                    // ì •ìƒ AI ë°œìŒ ì½”ì¹˜
                    coachMessageEl.style.cssText = 'padding: 8px; margin-bottom: 10px; background: #1a1a1a; border-radius: 6px;';
                    coachMessageEl.innerHTML = `
                        <div style="margin-bottom: 6px;">
                            <span style="color: #22c55e; font-size: 12px;">@${data.username}</span>
                            <span style="color: #22c55e; font-size: 12px; margin: 0 4px;">/</span>
                            <span style="color: #22c55e; font-size: 12px;">${escapeHtml(data.message)}</span>
                            <span style="color: #22c55e; font-size: 12px; margin: 0 4px;">(${escapeHtml(guide.originalMeaning || '')})</span>
                        </div>
                        <div style="margin-bottom: 6px;">
                            <span style="color: #3b82f6; font-size: 12px;">AI ì¶”ì²œë‹µë³€</span>
                            <span style="color: #3b82f6; font-size: 12px; margin: 0 4px;">${escapeHtml(guide.response || '')}</span>
                            <span style="color: #3b82f6; font-size: 12px;">(${escapeHtml(guide.responseMeaning || '')})</span>
                        </div>
                        <div>
                            <span style="color: #ef4444; font-size: 16px; font-weight: bold;">AI ë°œìŒ : ${escapeHtml(guide.pronunciation || '')}</span>
                        </div>
                    `;
                }
                
                foreignDiv.appendChild(coachMessageEl);
                foreignDiv.scrollTop = foreignDiv.scrollHeight;
            }
        }

        // í•œë„ ì´ˆê³¼ ìƒíƒœ í™•ì¸ ë° ë©”ì‹œì§€ í‘œì‹œ
        function checkAndShowLimitExceeded(usage) {
            if (!usage || !usage.pronunciationCoach) return;
            
            const { used, limit } = usage.pronunciationCoach;
            
            // í•œë„ ì´ˆê³¼ ìƒíƒœ í™•ì¸ (ë¬´ì œí•œì´ ì•„ë‹ˆê³ , ì‚¬ìš©ëŸ‰ì´ í•œë„ ì´ìƒì¼ ë•Œ)
            if (limit !== -1 && used >= limit) {
                console.log('âš ï¸ í˜ì´ì§€ ë¡œë“œ ì‹œ í•œë„ ì´ˆê³¼ ê°ì§€:', used, '/', limit);
                
                // í•œë„ ì´ˆê³¼ ë©”ì‹œì§€ í‘œì‹œ
                const foreignDiv = document.getElementById('foreignLanguageMessages');
                if (!foreignDiv) return;
                
                const empty = foreignDiv.querySelector('.empty-message');
                if (empty) empty.remove();
                
                // ì´ë¯¸ í•œë„ ì´ˆê³¼ ë©”ì‹œì§€ê°€ ìˆëŠ”ì§€ í™•ì¸
                const existingLimitMsg = foreignDiv.querySelector('.limit-exceeded-message');
                if (existingLimitMsg) return;
                
                const limitMessageEl = document.createElement('div');
                limitMessageEl.className = 'chat-message limit-exceeded-message';
                limitMessageEl.style.cssText = 'padding: 16px; margin-bottom: 10px; background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%); border-radius: 8px; border: 2px solid #fca5a5;';
                limitMessageEl.innerHTML = `
                    <div style="text-align: center;">
                        <div style="font-size: 24px; margin-bottom: 8px;">âš ï¸</div>
                        <div style="color: #fff; font-size: 14px; font-weight: bold; margin-bottom: 8px;">
                            ì¼ì¼ AI ë°œìŒ ì½”ì¹˜ í•œë„ ì´ˆê³¼
                        </div>
                        <div style="color: #fee2e2; font-size: 12px; margin-bottom: 12px;">
                            ì˜¤ëŠ˜ ì‚¬ìš©ëŸ‰: ${used}/${limit}
                        </div>
                        <button onclick="window.location.href='/dashboard/subscription'" style="
                            padding: 8px 16px;
                            background: #fff;
                            color: #dc2626;
                            border: none;
                            border-radius: 6px;
                            font-weight: bold;
                            cursor: pointer;
                            font-size: 13px;
                        ">
                            â¬†ï¸ í”Œëœ ì—…ê·¸ë ˆì´ë“œ
                        </button>
                    </div>
                `;
                
                foreignDiv.appendChild(limitMessageEl);
                limitExceededShown = true;
            }
        }

        // HTML ì´ìŠ¤ì¼€ì´í”„
        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        // ë¼ì´ë¸Œ ì‹œì‘
        document.getElementById('startBtn').onclick = async () => {
            if (!currentUser) {
                alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...');
                return;
            }

            if (!currentUser.tiktokId) {
                alert('ì„¤ì • í˜ì´ì§€ì—ì„œ TikTok IDë¥¼ ë¨¼ì € ë“±ë¡í•´ì£¼ì„¸ìš”.');
                window.location.href = '/dashboard/settings';
                return;
            }

            const userId = String(currentUser._id || currentUser.id);
            const tiktokId = currentUser.tiktokId;

            console.log('ğŸ¥ ë¼ì´ë¸Œ ì‹œì‘ ëª…ë ¹ ì „ì†¡:', { userId, tiktokId });
            
            // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            updateStatus('ì—°ê²° ì¤‘...', false);
            document.getElementById('startBtn').disabled = true;
            document.getElementById('startBtn').textContent = 'ì—°ê²° ì¤‘...';
            document.getElementById('stopBtn').disabled = false;
            
            socket.emit('start-live', { userId, tiktokId });
        };

        // ë¼ì´ë¸Œ ì¤‘ì§€
        document.getElementById('stopBtn').onclick = () => {
            if (!currentUser) return;

            const userId = String(currentUser._id || currentUser.id);
            console.log('â¹ï¸ ë¼ì´ë¸Œ ì¢…ë£Œ ëª…ë ¹ ì „ì†¡:', userId);
            socket.emit('stop-live', { userId });
            
            // ìƒíƒœ ì´ˆê¸°í™”
            isLive = false;
            localStorage.setItem('tikfind_live_state', 'false');
            updateStatus('ì—°ê²° ì•ˆ ë¨', false);
            
            // ë²„íŠ¼ ìƒíƒœ ë³€ê²½
            document.getElementById('startBtn').disabled = false;
            document.getElementById('startBtn').textContent = 'ì‹œì‘';
            document.getElementById('stopBtn').disabled = true;
            updateStatus('ì—°ê²° ì•ˆ ë¨', false);
        };

        // TTS ì„¤ì •
        document.getElementById('ttsEnabled').onchange = sendTTSSettings;
        document.getElementById('ttsSpeed').oninput = (e) => {
            document.getElementById('ttsSpeedValue').textContent = e.target.value + 'x';
            sendTTSSettings();
        };

        function sendTTSSettings() {
            if (!currentUser) return;

            const settings = {
                userId: String(currentUser._id || currentUser.id),
                enabled: document.getElementById('ttsEnabled').checked,
                speed: parseFloat(document.getElementById('ttsSpeed').value)
            };
            
            socket.emit('tts-settings', settings);
            console.log('ğŸ”Š TTS ì„¤ì • ì „ì†¡:', settings);
        }

        // ì‹ ì²­ê³¡ í ë¡œë“œ
        async function loadSongQueue(userId) {
            try {
                const response = await fetch(`/api/song-queue/${userId}`);
                const data = await response.json();
                if (data.success && data.queue) {
                    console.log('ğŸµ ì‹ ì²­ê³¡ í ë³µì›:', data.queue.length, 'ê³¡');
                    updateSongQueue(data.queue);
                }
            } catch (error) {
                console.error('âŒ ì‹ ì²­ê³¡ í ë¡œë“œ ì˜¤ë¥˜:', error);
            }
        }

        // ì‹ ì²­ê³¡ í ì—…ë°ì´íŠ¸ ìˆ˜ì‹ 
        socket.on('song-queue-update', (data) => {
            console.log('ğŸµ ì‹ ì²­ê³¡ í ì—…ë°ì´íŠ¸:', data.queue);
            updateSongQueue(data.queue);
        });

        // í˜„ì¬ ì‹ ì²­ê³¡ í ì €ì¥ (ì¬ìƒ ì‹œ URL ì°¸ì¡°ìš©)
        let currentSongQueue = [];
        let isYoutubePremium = false;
        let currentViewers = new Set(); // í˜„ì¬ ë°©ì— ìˆëŠ” ì‹œì²­ì ëª©ë¡
        let youtubeWindow = null; // YouTube ì¬ìƒ ì°½

        // ì‹ ì²­ê³¡ í UI ì—…ë°ì´íŠ¸
        function updateSongQueue(queue) {
            const queueList = document.getElementById('songQueueList');
            const songCount = document.getElementById('songCount');
            
            // í ì €ì¥
            currentSongQueue = queue || [];
            
            if (!queue || queue.length === 0) {
                queueList.innerHTML = '<p class="empty-message">ì‹ ì²­ê³¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
                songCount.textContent = 'ì´ 0ê³¡';
                return;
            }
            
            songCount.textContent = `ì´ ${queue.length}ê³¡`;
            
            queueList.innerHTML = queue.map((song, index) => {
                // ìŠ¤íŠ¸ë¦¬ë¨¸ê°€ ì§ì ‘ ì¶”ê°€í•œ ê³¡ì¸ì§€ í™•ì¸
                const isStreamerSong = song.requester === (currentUser?.tiktokId || 'Streamer') || 
                                      song.badges?.includes('streamer');
                
                // ì‹ ì²­ì í‘œì‹œ í…ìŠ¤íŠ¸
                let requesterText = '';
                if (isStreamerSong) {
                    requesterText = 'ì§ì ‘ì„ ê³¡';
                } else {
                    const isPresent = currentViewers.has(song.requester);
                    const presenceText = isPresent ? '' : ' <span style="color: #ef4444; font-size: 9px;">(ë°©ì— ì—†ìŒ)</span>';
                    requesterText = `@${escapeHtml(song.requester)}${presenceText}`;
                }
                
                return `
                <div class="song-item" style="
                    padding: 10px;
                    margin-bottom: 8px;
                    background: #1a1a1a;
                    border-radius: 6px;
                    border: 1px solid #333;
                    display: flex;
                    align-items: center;
                    gap: 10px;
                ">
                    <!-- ìˆœì„œ ë²ˆí˜¸ -->
                    <div style="font-size: 14px; font-weight: bold; color: #666; min-width: 20px;">
                        ${index + 1}
                    </div>
                    
                    <!-- ì˜ìƒ ì¸ë„¤ì¼ -->
                    <img src="${song.thumbnail}" alt="${song.title}" style="
                        width: 80px;
                        height: 60px;
                        border-radius: 4px;
                        object-fit: cover;
                    ">
                    
                    <!-- ë…¸ë˜ ì •ë³´ -->
                    <div style="flex: 1; min-width: 0;">
                        <div style="font-size: 12px; font-weight: bold; color: #fff; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">
                            ${escapeHtml(song.title)} - ${escapeHtml(song.artist)} | ì‹ ì²­: ${requesterText}
                        </div>
                    </div>
                    
                    <!-- ìˆœì„œ ë³€ê²½ ë²„íŠ¼ -->
                    <div style="display: flex; flex-direction: column; gap: 2px;">
                        <button onclick="moveSongUp(${index})" ${index === 0 ? 'disabled' : ''} style="
                            padding: 2px 6px;
                            background: ${index === 0 ? '#333' : '#4a5568'};
                            color: ${index === 0 ? '#666' : '#fff'};
                            border: none;
                            border-radius: 3px;
                            cursor: ${index === 0 ? 'not-allowed' : 'pointer'};
                            font-size: 10px;
                        ">â–²</button>
                        <button onclick="moveSongDown(${index})" ${index === queue.length - 1 ? 'disabled' : ''} style="
                            padding: 2px 6px;
                            background: ${index === queue.length - 1 ? '#333' : '#4a5568'};
                            color: ${index === queue.length - 1 ? '#666' : '#fff'};
                            border: none;
                            border-radius: 3px;
                            cursor: ${index === queue.length - 1 ? 'not-allowed' : 'pointer'};
                            font-size: 10px;
                        ">â–¼</button>
                    </div>
                    
                    <!-- ì¬ìƒ/ì‚­ì œ ë²„íŠ¼ -->
                    <div style="display: flex; gap: 4px;">
                        <button onclick="playSong('${song.id}')" style="
                            padding: 6px 10px;
                            background: #22c55e;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 16px;
                            line-height: 1;
                        ">â–¶</button>
                        <button onclick="removeSong('${song.id}')" style="
                            padding: 6px 10px;
                            background: #ef4444;
                            color: white;
                            border: none;
                            border-radius: 4px;
                            cursor: pointer;
                            font-size: 16px;
                            line-height: 1;
                        ">âœ•</button>
                    </div>
                </div>
            `;
            }).join('');
        }

        // ìŠ¤íŠ¸ë¦¬ë¨¸ ì‹ ì²­ê³¡ ì¶”ê°€
        async function streamerAddSong() {
            if (!currentUser) {
                alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘ì…ë‹ˆë‹¤...');
                return;
            }
            
            const titleInput = document.getElementById('streamerSongTitle');
            const artistInput = document.getElementById('streamerSongArtist');
            const title = titleInput.value.trim();
            const artist = artistInput.value.trim();
            
            if (!title) {
                alert('ë…¸ë˜ ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }
            
            try {
                const userId = String(currentUser._id || currentUser.id);
                const button = document.getElementById('streamerAddBtn');
                button.disabled = true;
                button.textContent = 'ğŸ” ê²€ìƒ‰ ì¤‘...';
                
                // SongRequestService ì‚¬ìš© (DB ì²´í¬ â†’ API ì¡°íšŒ â†’ DB ì €ì¥)
                const response = await fetch('/api/song-request/search', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ 
                        userId,
                        title, 
                        artist 
                    })
                });
                
                const data = await response.json();
                
                if (data.success && data.song) {
                    // DB ë˜ëŠ” APIì—ì„œ ì°¾ì€ ê³¡ ì¶”ê°€
                    const newSong = {
                        id: Date.now() + Math.random(),
                        videoId: data.song.videoId,
                        title: data.song.title || title,
                        artist: data.song.channelTitle || data.song.artist || artist,
                        requester: currentUser.tiktokId || 'Streamer',
                        thumbnail: data.song.thumbnail,
                        isStreamer: true // ìŠ¤íŠ¸ë¦¬ë¨¸ê°€ ì§ì ‘ ì¶”ê°€í•œ ê³¡
                    };
                    
                    autoPlayQueue.push(newSong);
                    updateAutoPlayQueue();
                    
                    // 1ì¼ ì‚¬ìš©ëŸ‰ ì¹´ìš´íŒ…
                    try {
                        await fetch('/api/usage/increment', {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({ 
                                userId: currentUser._id || currentUser.id,
                                featureType: 'songRequest'
                            })
                        });
                    } catch (err) {
                        console.error('ì‚¬ìš©ëŸ‰ ì¹´ìš´íŒ… ì˜¤ë¥˜:', err);
                    }
                    
                    // ì²« ê³¡ì´ë©´ ìë™ ì¬ìƒ
                    if (autoPlayQueue.length === 1) {
                        playNextAutoSong();
                    }
                    
                    titleInput.value = '';
                    artistInput.value = '';
                    console.log('âœ… ì‹ ì²­ê³¡ ì¶”ê°€:', title, '-', artist);
                    // ë²„íŠ¼ìœ¼ë¡œ í”¼ë“œë°± (alert ì œê±°)
                    button.textContent = 'âœ… ì¶”ê°€ ì™„ë£Œ!';
                    setTimeout(() => {
                        button.textContent = 'ğŸ” ê²€ìƒ‰ & ì¶”ê°€';
                    }, 2000);
                } else {
                    // ì—ëŸ¬ ë©”ì‹œì§€ í‘œì‹œ
                    console.error('âŒ ê²€ìƒ‰ ì‹¤íŒ¨:', data.message);
                    button.textContent = 'âŒ ê²€ìƒ‰ ì‹¤íŒ¨';
                    alert(data.message || 'ê³¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë‹¤ë¥¸ ê²€ìƒ‰ì–´ë¡œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                    setTimeout(() => {
                        button.textContent = 'ğŸ” ê²€ìƒ‰ & ì¶”ê°€';
                    }, 3000);
                }
                
                button.disabled = false;
            } catch (error) {
                console.error('âŒ ì‹ ì²­ê³¡ ì¶”ê°€ ì˜¤ë¥˜:', error);
                alert('ì‹ ì²­ê³¡ ì¶”ê°€ ì‹¤íŒ¨: ' + error.message);
                // ë²„íŠ¼ìœ¼ë¡œ í”¼ë“œë°±
                const button = document.getElementById('streamerAddBtn');
                if (button) {
                    button.disabled = false;
                    button.textContent = 'ğŸ” ê²€ìƒ‰ & ì¶”ê°€';
                }
            }
        }

        // YouTube Premium ìƒíƒœ ì—…ë°ì´íŠ¸
        function updateYoutubePremiumStatus() {
            const premiumYes = document.getElementById('premiumYes');
            isYoutubePremium = premiumYes.checked;
            
            // localStorageì— ì €ì¥
            localStorage.setItem('tikfind_youtube_premium', isYoutubePremium);
            
            console.log('ğŸµ YouTube Premium ìƒíƒœ:', isYoutubePremium ? 'ê°€ì…' : 'ë¯¸ê°€ì…');
            
            if (isYoutubePremium) {
                alert('âœ… YouTube Premium ìë™ì¬ìƒ ëª¨ë“œê°€ í™œì„±í™”ë˜ì—ˆìŠµë‹ˆë‹¤.\në…¸ë˜ê°€ ëë‚˜ë©´ ìë™ìœ¼ë¡œ ë‹¤ìŒ ê³¡ì´ ì¬ìƒë©ë‹ˆë‹¤.');
            } else {
                alert('âŒ ìˆ˜ë™ ì¬ìƒ ëª¨ë“œì…ë‹ˆë‹¤.\nê° ê³¡ë§ˆë‹¤ ì¬ìƒ ë²„íŠ¼ì„ í´ë¦­í•´ì£¼ì„¸ìš”.');
            }
        }

        // YouTube ì˜ìƒ ê¸¸ì´ ê°€ì ¸ì˜¤ê¸° (YouTube Data API)
        async function getYoutubeVideoDuration(videoId) {
            try {
                const response = await fetch(`/api/youtube/duration/${videoId}`);
                const data = await response.json();
                if (data.success && data.duration) {
                    return data.duration; // ì´ˆ ë‹¨ìœ„
                }
                return null;
            } catch (error) {
                console.error('âŒ YouTube ì˜ìƒ ê¸¸ì´ ì¡°íšŒ ì˜¤ë¥˜:', error);
                return null;
            }
        }

        // ë‹¤ìŒ ê³¡ ìë™ ì¬ìƒ
        function playNextSong() {
            if (currentSongQueue.length === 0) {
                console.log('âœ… ëª¨ë“  ì‹ ì²­ê³¡ ì¬ìƒ ì™„ë£Œ');
                return;
            }
            
            const nextSong = currentSongQueue[0];
            playSong(nextSong.id);
        }

        // ì‹ ì²­ê³¡ ìˆœì„œ ìœ„ë¡œ ì´ë™
        function moveSongUp(index) {
            if (!currentUser || index === 0) return;
            
            const userId = String(currentUser._id || currentUser.id);
            const songId = currentSongQueue[index].id;
            const newPosition = index - 1;
            
            fetch('/api/song-queue/move', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId, songId, newPosition })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    console.log('âœ… ì‹ ì²­ê³¡ ìˆœì„œ ë³€ê²½:', songId, 'â†’', newPosition);
                }
            })
            .catch(error => {
                console.error('âŒ ì‹ ì²­ê³¡ ìˆœì„œ ë³€ê²½ ì˜¤ë¥˜:', error);
            });
        }

        // ì‹ ì²­ê³¡ ìˆœì„œ ì•„ë˜ë¡œ ì´ë™
        function moveSongDown(index) {
            if (!currentUser || index === currentSongQueue.length - 1) return;
            
            const userId = String(currentUser._id || currentUser.id);
            const songId = currentSongQueue[index].id;
            const newPosition = index + 1;
            
            fetch('/api/song-queue/move', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId, songId, newPosition })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    console.log('âœ… ì‹ ì²­ê³¡ ìˆœì„œ ë³€ê²½:', songId, 'â†’', newPosition);
                }
            })
            .catch(error => {
                console.error('âŒ ì‹ ì²­ê³¡ ìˆœì„œ ë³€ê²½ ì˜¤ë¥˜:', error);
            });
        }

        // ì‹ ì²­ê³¡ ì¬ìƒ
        async function playSong(songId) {
            if (!currentUser) return;
            
            // í˜„ì¬ íì—ì„œ í•´ë‹¹ ê³¡ ì°¾ê¸°
            const song = currentSongQueue.find(s => s.id === songId);
            if (!song) {
                console.error('âŒ ì‹ ì²­ê³¡ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤:', songId);
                return;
            }
            
            console.log('âœ… ì‹ ì²­ê³¡ ì¬ìƒ:', song.title, '-', song.artist);
            
            // ì„œë²„ì— ì¬ìƒ ì™„ë£Œ ì•Œë¦¼
            const userId = String(currentUser._id || currentUser.id);
            fetch('/api/song-queue/played', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId, songId })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    // ì¬ìƒ ì™„ë£Œ í›„ ì‚­ì œ
                    setTimeout(() => removeSong(songId), 1000);
                }
            })
            .catch(error => {
                console.error('âŒ ì‹ ì²­ê³¡ ì¬ìƒ ì˜¤ë¥˜:', error);
            });
            
            // ìë™ì¬ìƒì€ YouTube Playerì˜ onStateChange ì´ë²¤íŠ¸ì—ì„œ ì²˜ë¦¬
        }

        // ì‹ ì²­ê³¡ ì‚­ì œ
        function removeSong(songId) {
            if (!currentUser) return;
            
            const userId = String(currentUser._id || currentUser.id);
            
            fetch('/api/song-queue/remove', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ userId, songId })
            })
            .then(res => res.json())
            .then(data => {
                if (data.success) {
                    console.log('âœ… ì‹ ì²­ê³¡ ì‚­ì œ:', songId);
                }
            })
            .catch(error => {
                console.error('âŒ ì‹ ì²­ê³¡ ì‚­ì œ ì˜¤ë¥˜:', error);
            });
        }

        // ì „ì²´ ì‚­ì œ
        function clearAllSongs() {
            if (!confirm('ëª¨ë“  ì‹ ì²­ê³¡ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
            
            // autoPlayQueue ì´ˆê¸°í™”
            autoPlayQueue = [];
            
            // localStorageì—ì„œ ì‚­ì œ
            localStorage.removeItem('tikfind_song_queue');
            
            // UI ì—…ë°ì´íŠ¸
            updateAutoPlayQueue();
            
            // ì¬ìƒ ì¤‘ì¸ ë¹„ë””ì˜¤ ì •ì§€
            if (currentVideoPlayer) {
                currentVideoPlayer.pause();
                currentVideoPlayer = null;
            }
            
            document.getElementById('youtubePlayer').innerHTML = '<p style="color: #666; font-size: 12px;">ì‹ ì²­ê³¡ì´ ì—†ìŠµë‹ˆë‹¤</p>';
            document.getElementById('nowPlaying').style.display = 'none';
            
            console.log('ğŸ—‘ï¸ ì „ì²´ ì‚­ì œ ì™„ë£Œ');
        }

        // ëª©ë¡ ì €ì¥
        function exportPlaylist() {
            console.log('ğŸ’¾ ëª©ë¡ ì €ì¥');
            alert('ëª©ë¡ ì €ì¥ ê¸°ëŠ¥ì€ ì¶”í›„ êµ¬í˜„ ì˜ˆì •ì…ë‹ˆë‹¤.');
        }

        // ========== YouTube ìë™ì¬ìƒ ì‹œìŠ¤í…œ (ytdl-core) ==========
        let autoPlayQueue = [];
        let currentVideoPlayer = null;
        let isRequestAccepting = true; // ì‹ ì²­ê³¡ ë°›ê¸° ìƒíƒœ
        let requestCooldownMinutes = 30; // ì‹ ì²­ ì‹œê°„ ì œí•œ (ë¶„)
        let autoSkipAbsentSetting = true; // ë¶€ì¬ì ìë™ íŒ¨ìŠ¤
        let lastRequestTime = {}; // ë§ˆì§€ë§‰ ì‹ ì²­ ì‹œê°„ ê¸°ë¡

        // í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ì „ ìƒíƒœ ë³µì›
        window.addEventListener('DOMContentLoaded', () => {
            const savedLiveState = localStorage.getItem('tikfind_live_state');
            if (savedLiveState === 'true') {
                isLive = true;
                updateStatus('ë°©ì†¡ ì¤‘ (ë³µì›ë¨)', true);
                document.getElementById('startBtn').disabled = true;
                document.getElementById('startBtn').textContent = 'ë°©ì†¡ ì¤‘';
                document.getElementById('stopBtn').disabled = false;
            }
            
            // ì¥ë¥´ ëª©ë¡ ë¡œë“œ (Genre ëª¨ë¸ ê¸°ë°˜)
            async function updateGenreStats() {
                try {
                    const response = await fetch('/api/admin/genres');
                    const data = await response.json();
                    
                    if (data.success && data.genres && data.genres.length > 0) {
                        const genreSelect = document.getElementById('genreSelect');
                        
                        // ë“œë¡­ë‹¤ìš´ ì˜µì…˜ ì—…ë°ì´íŠ¸ (ì²« ë©”ë‰´ í¬í•¨)
                        genreSelect.innerHTML = `
                            <option value="" disabled selected>AIì¬ìƒì¥ë¥´ì„ íƒ</option>
                            ${data.genres.map(genre => 
                                `<option value="${genre._id}">${genre.name} (${genre.curatedCount || 0}ê³¡)</option>`
                            ).join('')}
                        `;
                        
                        console.log('âœ… AI íë ˆì´ì…˜ ì¥ë¥´ ë¡œë“œ:', data.genres.length, 'ê°œ');
                    } else {
                        const genreSelect = document.getElementById('genreSelect');
                        genreSelect.innerHTML = '<option value="" disabled selected>ì¥ë¥´ë¥¼ ë¨¼ì € ì¶”ê°€í•˜ì„¸ìš”</option>';
                        console.log('âš ï¸ íë ˆì´ì…˜ëœ ì¥ë¥´ê°€ ì—†ìŠµë‹ˆë‹¤');
                    }
                } catch (error) {
                    console.error('âŒ ì¥ë¥´ ëª©ë¡ ë¡œë“œ ì‹¤íŒ¨:', error);
                }
            }
            
            // ì¥ë¥´ë³„ ê³¡ ìˆ˜ ì—…ë°ì´íŠ¸
            updateGenreStats();
            
            // ì €ì¥ëœ ë…¸ë˜ í ë³µì›
            loadQueueFromStorage();
            
            // ì´ˆê¸° ì¿¨ë‹¤ìš´ ì„¤ì • ì „ë‹¬
            (async () => {
                try {
                    const response = await fetch('/api/song-cooldown/update', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            cooldownMinutes: requestCooldownMinutes
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        console.log('âœ… ì´ˆê¸° ì¿¨ë‹¤ìš´ ì„¤ì •:', requestCooldownMinutes, 'ë¶„');
                    }
                } catch (error) {
                    console.error('âŒ ì´ˆê¸° ì¿¨ë‹¤ìš´ ì„¤ì • ì˜¤ë¥˜:', error);
                }
            })();
            
            // AI ìë™ì¬ìƒ ìƒíƒœ
            let aiAutoPlayEnabled = false;
            let aiAutoPlayInterval = null;
            let playedSongIds = []; // ì´ë¯¸ ì¬ìƒí•œ ê³¡ ID ì¶”ì 
            
            // AI ìë™ì¬ìƒ ë²„íŠ¼
            document.getElementById('aiAutoPlayBtn').onclick = () => {
                const startBtn = document.getElementById('aiAutoPlayBtn');
                const stopBtn = document.getElementById('aiAutoPlayStopBtn');
                const genreId = document.getElementById('genreSelect').value;
                
                if (!genreId) {
                    alert('ì¥ë¥´ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”');
                    return;
                }
                
                // ìë™ì¬ìƒ ì‹œì‘
                aiAutoPlayEnabled = true;
                playedSongIds = []; // ì¬ìƒ ëª©ë¡ ì´ˆê¸°í™”
                startBtn.style.display = 'none';
                stopBtn.style.display = 'block';
                console.log('ğŸ¤– AI ìë™ì¬ìƒ ì‹œì‘ - ì¥ë¥´ ID:', genreId);
                
                // íê°€ ë¹„ë©´ ìë™ìœ¼ë¡œ AI ê³¡ ì¶”ê°€
                aiAutoPlayInterval = setInterval(async () => {
                    if (autoPlayQueue.length === 0 && aiAutoPlayEnabled) {
                        console.log('ğŸµ íê°€ ë¹„ì–´ì„œ AI ê³¡ ìë™ ì¶”ê°€');
                        await addAISong(genreId);
                    }
                }, 3000); // 3ì´ˆë§ˆë‹¤ ì²´í¬
                
                // ì¦‰ì‹œ ì²« ê³¡ ì¶”ê°€
                console.log('ğŸµ ì¦‰ì‹œ ì²« ê³¡ ì¶”ê°€ ì‹œì‘');
                addAISong(genreId);
            };
            
            // AI ìë™ì¬ìƒ ë©ˆì¶¤ ë²„íŠ¼
            document.getElementById('aiAutoPlayStopBtn').onclick = () => {
                const startBtn = document.getElementById('aiAutoPlayBtn');
                const stopBtn = document.getElementById('aiAutoPlayStopBtn');
                const aiCurrentSong = document.getElementById('aiCurrentSong');
                
                // ìë™ì¬ìƒ ì¤‘ì§€
                aiAutoPlayEnabled = false;
                startBtn.style.display = 'block';
                stopBtn.style.display = 'none';
                aiCurrentSong.style.display = 'none';
                console.log('ğŸ›‘ AI ìë™ì¬ìƒ ì¤‘ì§€');
                
                if (aiAutoPlayInterval) {
                    clearInterval(aiAutoPlayInterval);
                    aiAutoPlayInterval = null;
                }
            };
            
            // AI ê³¡ ì¶”ê°€ í•¨ìˆ˜
            async function addAISong(genreId) {
                try {
                    console.log('ğŸ¤– AI ê³¡ ì¶”ê°€ ì‹œì‘ - ì¥ë¥´ ID:', genreId);
                    console.log('ğŸš« ì œì™¸í•  ê³¡ ID:', playedSongIds.length, 'ê°œ');
                    
                    const response = await fetch('/api/popular-songs/random', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ 
                            genreId: genreId, 
                            count: 1,
                            excludeIds: playedSongIds
                        })
                    });
                    
                    const data = await response.json();
                    console.log('ğŸ¤– AI ê³¡ API ì‘ë‹µ:', data);
                    
                    // ì œì™¸ ëª©ë¡ ì´ˆê¸°í™” í•„ìš” ì‹œ
                    if (data.resetExcludeList) {
                        console.log('ğŸ”„ ì¬ìƒ ëª©ë¡ ì´ˆê¸°í™” (ëª¨ë“  ê³¡ ì¬ìƒ ì™„ë£Œ)');
                        playedSongIds = [];
                    }
                    
                    if (data.success && data.songs.length > 0) {
                        const song = data.songs[0];
                        const newSong = {
                            id: Date.now() + Math.random(),
                            dbId: song.id, // DB ID ì €ì¥
                            videoId: song.videoId,
                            title: song.title,
                            artist: song.artist,
                            requester: 'AI ì¶”ì²œ',
                            thumbnail: song.thumbnail,
                            isAI: true
                        };
                        
                        // ì¬ìƒ ëª©ë¡ì— ì¶”ê°€
                        playedSongIds.push(song.id);
                        console.log('ğŸ¤– íì— ì¶”ê°€í•  ê³¡:', newSong);
                        console.log('ğŸ“ ì¬ìƒ ëª©ë¡ ì—…ë°ì´íŠ¸:', playedSongIds.length, 'ê°œ');
                        
                        autoPlayQueue.push(newSong);
                        updateAutoPlayQueue();
                        console.log('ğŸ“‹ ì¶”ê°€ í›„ í ê¸¸ì´:', autoPlayQueue.length);
                        
                        // AI í˜„ì¬ ì¬ìƒê³¡ UI ì—…ë°ì´íŠ¸
                        const aiCurrentSong = document.getElementById('aiCurrentSong');
                        const aiSongTitle = document.getElementById('aiSongTitle');
                        aiCurrentSong.style.display = 'block';
                        aiSongTitle.textContent = `${song.title} - ${song.artist}`;
                        
                        // ì²« ê³¡ì´ë©´ ìë™ ì¬ìƒ
                        if (autoPlayQueue.length === 1) {
                            console.log('ğŸµ ì²« ê³¡ì´ë¯€ë¡œ ìë™ ì¬ìƒ ì‹œì‘');
                            console.log('ğŸµ YouTube Player ìƒíƒœ:', {
                                exists: !!youtubePlayer,
                                ready: isPlayerReady
                            });
                            
                            // YouTube Playerê°€ ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
                            if (!youtubePlayer || !isPlayerReady) {
                                console.log('â³ YouTube Player ì´ˆê¸°í™” ëŒ€ê¸° ì¤‘...');
                                const checkPlayer = setInterval(() => {
                                    if (youtubePlayer && isPlayerReady) {
                                        console.log('âœ… YouTube Player ì¤€ë¹„ ì™„ë£Œ, ì¬ìƒ ì‹œì‘');
                                        clearInterval(checkPlayer);
                                        playNextAutoSong();
                                    }
                                }, 500);
                                
                                // 5ì´ˆ í›„ì—ë„ ì¤€ë¹„ ì•ˆë˜ë©´ ê°•ì œ ì´ˆê¸°í™”
                                setTimeout(() => {
                                    if (!youtubePlayer || !isPlayerReady) {
                                        console.log('âš ï¸ YouTube Player ì´ˆê¸°í™” íƒ€ì„ì•„ì›ƒ, ê°•ì œ ì´ˆê¸°í™”');
                                        clearInterval(checkPlayer);
                                        initYouTubePlayer();
                                        setTimeout(() => playNextAutoSong(), 2000);
                                    }
                                }, 5000);
                            } else {
                                await playNextAutoSong();
                            }
                        } else {
                            console.log('ğŸ“‹ íì— ì¶”ê°€ë§Œ í•¨ (í˜„ì¬', autoPlayQueue.length, 'ê³¡)');
                        }
                        
                        console.log('âœ… AI ê³¡ ì¶”ê°€ ì™„ë£Œ:', song.title, '-', song.artist);
                    } else {
                        console.log('âš ï¸ AI ê³¡ ì—†ìŒ - ì‘ë‹µ:', data);
                    }
                } catch (error) {
                    console.error('âŒ AI ê³¡ ì¶”ê°€ ì˜¤ë¥˜:', error);
                }
            }

            // AI ìë™ì¬ìƒ ê³¡ ìŠ¤í‚µ
            window.skipAISong = () => {
                console.log('â­ï¸ AI ê³¡ ìŠ¤í‚µ');
                if (youtubePlayer && isPlayerReady) {
                    youtubePlayer.stopVideo();
                }
                if (autoPlayQueue.length > 0 && autoPlayQueue[0].isAI) {
                    autoPlayQueue.shift();
                    updateAutoPlayQueue();
                    playNextAutoSong();
                }
            };

            // ë‹¤ìŒ ê³¡ ë²„íŠ¼
            document.getElementById('nextSongBtn').onclick = () => {
                if (autoPlayQueue.length > 0) {
                    console.log('â­ï¸ ë‹¤ìŒ ê³¡ìœ¼ë¡œ ìŠ¤í‚µ - í˜„ì¬ í:', autoPlayQueue.length, 'ê³¡');
                    console.log('â­ï¸ í˜„ì¬ ì¬ìƒ ì¤‘:', autoPlayQueue[0]?.title);
                    
                    // YouTube Player ì •ì§€ (onStateChange ì´ë²¤íŠ¸ ë°©ì§€)
                    if (youtubePlayer && isPlayerReady) {
                        youtubePlayer.stopVideo();
                    }
                    
                    // í˜„ì¬ ê³¡ ì œê±°
                    const removed = autoPlayQueue.shift();
                    console.log('â­ï¸ ì œê±°ëœ ê³¡:', removed?.title);
                    console.log('â­ï¸ shift í›„ í:', autoPlayQueue.length, 'ê³¡');
                    console.log('â­ï¸ ë‹¤ìŒ ì¬ìƒí•  ê³¡:', autoPlayQueue[0]?.title);
                    
                    updateAutoPlayQueue();
                    playNextAutoSong();
                } else {
                    alert('ì¬ìƒí•  ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                }
            };

            // ìŒì•… ì¼ì‹œì •ì§€/ì¬ìƒ ë²„íŠ¼
            let isPaused = false;
            document.getElementById('pausePlayBtn').onclick = () => {
                const btn = document.getElementById('pausePlayBtn');
                if (youtubePlayer && isPlayerReady) {
                    const state = youtubePlayer.getPlayerState();
                    // 1 = ì¬ìƒ ì¤‘, 2 = ì¼ì‹œì •ì§€
                    if (state === 1) {
                        youtubePlayer.pauseVideo();
                        btn.innerHTML = '<i class="fas fa-play" style="margin-right: 2px;"></i>ì¬ìƒ';
                        btn.style.background = '#10b981';
                        console.log('â¸ï¸ ìŒì•… ì¼ì‹œì •ì§€');
                        isPaused = true;
                    } else {
                        youtubePlayer.playVideo();
                        btn.innerHTML = '<i class="fas fa-pause" style="margin-right: 2px;"></i>ì¼ì‹œì •ì§€';
                        btn.style.background = '#f59e0b';
                        console.log('â–¶ï¸ ìŒì•… ì¬ìƒ');
                        isPaused = false;
                    }
                } else {
                    alert('ì¬ìƒ ì¤‘ì¸ ê³¡ì´ ì—†ìŠµë‹ˆë‹¤.');
                }
            };

            // ì‹ ì²­ê³¡ ë°›ê¸°/ì•ˆë°›ê¸° ë“œë¡­ë‹¤ìš´
            document.getElementById('requestAcceptSelect').onchange = (e) => {
                const value = e.target.value;
                if (value === 'accept') {
                    isRequestAccepting = true;
                    console.log('âœ… ì‹ ì²­ê³¡ ë°›ê¸° ì‹œì‘');
                } else {
                    isRequestAccepting = false;
                    console.log('âŒ ì‹ ì²­ê³¡ ì•ˆë°›ê¸°');
                }
            };

            // ì‹œê°„ ì œí•œ ì„¤ì •
            document.getElementById('requestCooldown').onchange = async (e) => {
                requestCooldownMinutes = parseInt(e.target.value);
                console.log('â±ï¸ ì‹ ì²­ ì‹œê°„ ì œí•œ:', requestCooldownMinutes, 'ë¶„');
                
                // ì„œë²„ì— ì¿¨ë‹¤ìš´ ì„¤ì • ì „ë‹¬
                try {
                    const response = await fetch('/api/song-cooldown/update', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            cooldownMinutes: requestCooldownMinutes
                        })
                    });
                    
                    const data = await response.json();
                    if (data.success) {
                        console.log('âœ… ì„œë²„ ì¿¨ë‹¤ìš´ ì„¤ì • ì—…ë°ì´íŠ¸:', requestCooldownMinutes, 'ë¶„');
                    } else {
                        console.error('âŒ ì¿¨ë‹¤ìš´ ì„¤ì • ì‹¤íŒ¨:', data.message);
                    }
                } catch (error) {
                    console.error('âŒ ì¿¨ë‹¤ìš´ ì„¤ì • ì˜¤ë¥˜:', error);
                }
            };

            // ë¶€ì¬ì ìë™ íŒ¨ìŠ¤ ì„¤ì •
            document.getElementById('autoSkipAbsent').onchange = (e) => {
                autoSkipAbsentSetting = e.target.checked;
                console.log('ğŸ‘¤ ë¶€ì¬ì ìë™ íŒ¨ìŠ¤:', autoSkipAbsentSetting ? 'í™œì„±í™”' : 'ë¹„í™œì„±í™”');
            };
        });

        // ì‹ ì²­ê³¡ ì•ˆë‚´ ë³µì‚¬ ê¸°ëŠ¥
        function copyRequestGuide() {
            const guideText = 'ì‹ ì²­ê³¡ ì‹ ì²­ì€ #ë…¸ë˜ì œëª©#ê°€ìˆ˜ì´ë¦„ ì±„íŒ…ì°½ì— ë‚¨ê²¨ì£¼ì„¸ìš”. ì˜ˆì‹œ: #Dynamite#BTS';
            
            navigator.clipboard.writeText(guideText).then(() => {
                const btn = document.getElementById('copyGuideBtn');
                const originalHTML = btn.innerHTML;
                btn.innerHTML = '<i class="fas fa-check" style="margin-right: 2px;"></i>ë³µì‚¬ë¨!';
                btn.style.background = 'rgba(34, 197, 94, 0.3)';
                
                setTimeout(() => {
                    btn.innerHTML = originalHTML;
                    btn.style.background = 'rgba(255,255,255,0.2)';
                }, 2000);
                
                console.log('âœ… ì‹ ì²­ê³¡ ì•ˆë‚´ ë³µì‚¬ë¨');
            }).catch(err => {
                console.error('âŒ ë³µì‚¬ ì‹¤íŒ¨:', err);
                alert('ë³µì‚¬ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ìˆ˜ë™ìœ¼ë¡œ ë³µì‚¬í•´ì£¼ì„¸ìš”.');
            });
        }

        // í˜ì´ì§€ ì–¸ë¡œë“œ ì‹œ (ìƒˆë¡œê³ ì¹¨/ë‹«ê¸°)
        window.addEventListener('beforeunload', () => {
            // ë¼ì´ë¸Œ ìƒíƒœ ìœ ì§€ (localStorageì— ì €ì¥ë¨)
        });

        // localStorageì— í ì €ì¥
        function saveQueueToStorage() {
            try {
                localStorage.setItem('tikfind_song_queue', JSON.stringify(autoPlayQueue));
                console.log('ğŸ’¾ ë…¸ë˜ í ì €ì¥:', autoPlayQueue.length, 'ê³¡');
            } catch (error) {
                console.error('âŒ í ì €ì¥ ì‹¤íŒ¨:', error);
            }
        }

        // localStorageì—ì„œ í ë³µì›
        function loadQueueFromStorage() {
            try {
                const savedQueue = localStorage.getItem('tikfind_song_queue');
                if (savedQueue) {
                    autoPlayQueue = JSON.parse(savedQueue);
                    console.log('âœ… ë…¸ë˜ í ë³µì›:', autoPlayQueue.length, 'ê³¡');
                    updateAutoPlayQueue();
                    
                    // ì²« ê³¡ì´ ìˆìœ¼ë©´ ìë™ ì¬ìƒ
                    if (autoPlayQueue.length > 0) {
                        playNextAutoSong();
                    }
                }
            } catch (error) {
                console.error('âŒ í ë³µì› ì‹¤íŒ¨:', error);
                autoPlayQueue = [];
            }
        }

        // ìë™ì¬ìƒ í ì—…ë°ì´íŠ¸
        function updateAutoPlayQueue() {
            const queueList = document.getElementById('songQueueList');
            const songCount = document.getElementById('songCount');
            
            songCount.textContent = `ì´ ${autoPlayQueue.length}ê³¡`;
            
            // localStorageì— ì €ì¥
            saveQueueToStorage();
            
            if (autoPlayQueue.length === 0) {
                queueList.innerHTML = '<p class="empty-message">ì‹ ì²­ê³¡ì´ ì—¬ê¸°ì— í‘œì‹œë©ë‹ˆë‹¤...</p>';
                return;
            }
            
            queueList.innerHTML = autoPlayQueue.map((song, index) => {
                const isPlaying = index === 0;
                const isStreamerSong = song.isStreamer === true;
                const isAISong = song.requester === 'AI ì¶”ì²œ';
                // ìŠ¤íŠ¸ë¦¬ë¨¸ ì§ì ‘ ë“±ë¡ ë˜ëŠ” AI ì¶”ì²œ ë˜ëŠ” ì‹œì²­ì ì¬ì‹¤ ì¤‘
                const isPresent = isStreamerSong || isAISong || currentViewers.has(song.requester);
                const isFailed = song.failed || false;
                
                let statusBadges = '';
                // ìŠ¤íŠ¸ë¦¬ë¨¸ ì§ì ‘ ë“±ë¡ ê³¡ í‘œì‹œ
                if (isStreamerSong) {
                    statusBadges += '<span style="font-size: 9px; color: #9333ea; background: rgba(147, 51, 234, 0.2); padding: 2px 6px; border-radius: 3px; margin-left: 4px;">ğŸ¤ ìŠ¤íŠ¸ë¦¬ë¨¸</span>';
                }
                // ë¶€ì¬ í‘œì‹œ (ìŠ¤íŠ¸ë¦¬ë¨¸/AI ì œì™¸)
                if (!isPresent && !isStreamerSong && !isAISong) {
                    statusBadges += '<span style="font-size: 9px; color: #ef4444; background: rgba(239, 68, 68, 0.2); padding: 2px 6px; border-radius: 3px; margin-left: 4px;">ë¶€ì¬</span>';
                }
                if (isFailed) {
                    statusBadges += '<span style="font-size: 9px; color: #f59e0b; background: rgba(245, 158, 11, 0.2); padding: 2px 6px; border-radius: 3px; margin-left: 4px;">âš ï¸ ì¬ìƒë¶ˆê°€</span>';
                }
                
                return `
                    <div style="display: flex; align-items: center; gap: 8px; padding: 8px; background: ${isPlaying ? 'rgba(147, 51, 234, 0.2)' : (isFailed ? 'rgba(245, 158, 11, 0.1)' : (!isPresent ? 'rgba(239, 68, 68, 0.1)' : '#1a1a1a'))}; border-radius: 4px; margin-bottom: 4px; ${!isPresent || isFailed ? 'opacity: 0.7;' : ''}">
                        <div style="width: 20px; text-align: center; font-size: 11px; color: ${isPlaying ? '#9333ea' : '#666'};">
                            ${isPlaying ? 'â–¶' : index + 1}
                        </div>
                        <img src="${song.thumbnail}" style="width: 48px; height: 36px; border-radius: 4px; object-fit: cover;">
                        <div style="flex: 1; min-width: 0;">
                            <p style="font-size: 12px; font-weight: 600; color: white; margin: 0; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;">${song.title}</p>
                            <p style="font-size: 10px; color: #999; margin: 2px 0 0 0;">${song.artist}</p>
                            <p style="font-size: 10px; color: #666; margin: 2px 0 0 0; display: flex; align-items: center;">
                                ì‹ ì²­: ${song.requester}${statusBadges}
                            </p>
                            ${isFailed ? `<p style="font-size: 9px; color: #f59e0b; margin: 2px 0 0 0;">ğŸ’¬ ì‹œì²­ìì—ê²Œ ë‹¤ë¥¸ ê³¡ ì‹ ì²­ ìš”ì²­</p>` : ''}
                        </div>
                        ${isPlaying ? '<div style="width: 16px; height: 16px; border: 2px solid #9333ea; border-top-color: transparent; border-radius: 50%; animation: spin 1s linear infinite;"></div>' : `<button onclick="removeAutoSong(${song.id})" style="padding: 4px 8px; background: #dc2626; color: white; border: none; border-radius: 4px; font-size: 10px; cursor: pointer;">ì‚­ì œ</button>`}
                    </div>
                `;
            }).join('');
        }

        // ìë™ì¬ìƒ íì—ì„œ ì‚­ì œ
        window.removeAutoSong = (songId) => {
            autoPlayQueue = autoPlayQueue.filter(s => s.id !== songId);
            updateAutoPlayQueue();
        };

        // YouTube IFrame Player ì „ì—­ ë³€ìˆ˜
        let youtubePlayer = null;
        let isPlayerReady = false;

        // YouTube IFrame API ì¤€ë¹„ ì™„ë£Œ ì½œë°±
        window.onYouTubeIframeAPIReady = function() {
            console.log('âœ… YouTube IFrame API ì¤€ë¹„ ì™„ë£Œ');
            initYouTubePlayer();
        };

        // YouTube Player ì´ˆê¸°í™”
        function initYouTubePlayer() {
            const playerDiv = document.getElementById('youtubePlayer');
            playerDiv.innerHTML = '<div id="ytPlayer"></div>';
            
            youtubePlayer = new YT.Player('ytPlayer', {
                height: '100%',
                width: '100%',
                videoId: '',
                playerVars: {
                    autoplay: 0,
                    controls: 1,
                    rel: 0,                    // ê´€ë ¨ ë™ì˜ìƒ í‘œì‹œ ì•ˆ í•¨
                    modestbranding: 1,         // YouTube ë¡œê³  ìµœì†Œí™”
                    fs: 1,                     // ì „ì²´í™”ë©´ ë²„íŠ¼ í‘œì‹œ
                    cc_load_policy: 0,         // ìë§‰ ê¸°ë³¸ ë¹„í™œì„±í™”
                    iv_load_policy: 3,         // ì£¼ì„ í‘œì‹œ ì•ˆ í•¨
                    disablekb: 0,              // í‚¤ë³´ë“œ ì»¨íŠ¸ë¡¤ í™œì„±í™”
                    playsinline: 1,            // ì¸ë¼ì¸ ì¬ìƒ
                    origin: window.location.origin  // ë³´ì•ˆ ì„¤ì •
                },
                events: {
                    'onReady': onPlayerReady,
                    'onStateChange': onPlayerStateChange,
                    'onError': onPlayerError
                }
            });
        }

        // Player ì¤€ë¹„ ì™„ë£Œ
        function onPlayerReady(event) {
            console.log('âœ… YouTube Player ì¤€ë¹„ ì™„ë£Œ');
            isPlayerReady = true;
            currentVideoPlayer = youtubePlayer;
        }

        // ê´‘ê³  ê°ì§€ íƒ€ì´ë¨¸
        let adCheckInterval = null;

        // Player ìƒíƒœ ë³€í™” ê°ì§€ (í•µì‹¬: ë‹¤ìŒ ê³¡ ìë™ ì¬ìƒ)
        function onPlayerStateChange(event) {
            console.log('ğŸ¬ Player ìƒíƒœ ë³€ê²½:', event.data, '(0=ì¢…ë£Œ, 1=ì¬ìƒ, 2=ì¼ì‹œì •ì§€, 3=ë²„í¼ë§, 5=ì¤€ë¹„)');
            
            // YT.PlayerState.ENDED = 0 (ì¬ìƒ ì¢…ë£Œ)
            if (event.data === YT.PlayerState.ENDED) {
                console.log('âœ… ì¬ìƒ ì™„ë£Œ, ë‹¤ìŒ ê³¡ìœ¼ë¡œ...');
                console.log('ğŸ“‹ í˜„ì¬ í:', autoPlayQueue.length, 'ê³¡');
                if (adCheckInterval) {
                    clearInterval(adCheckInterval);
                    adCheckInterval = null;
                }
                autoPlayQueue.shift();
                updateAutoPlayQueue();
                console.log('ğŸ“‹ shift í›„ í:', autoPlayQueue.length, 'ê³¡');
                playNextAutoSong();
            }
            // YT.PlayerState.PLAYING = 1 (ì¬ìƒ ì¤‘)
            else if (event.data === YT.PlayerState.PLAYING) {
                console.log('â–¶ï¸ ì¬ìƒ ì‹œì‘');
                
                // ê´‘ê³  ê°ì§€ ì‹œì‘
                if (adCheckInterval) clearInterval(adCheckInterval);
                adCheckInterval = setInterval(() => {
                    try {
                        // ê´‘ê³  URL íŒ¨í„´ ê°ì§€
                        const playerUrl = youtubePlayer.getVideoUrl();
                        if (playerUrl && (playerUrl.includes('/ads') || playerUrl.includes('googleads'))) {
                            console.log('ğŸš« ê´‘ê³  ê°ì§€ - ë‹¤ìŒ ê³¡ìœ¼ë¡œ ìŠ¤í‚µ');
                            clearInterval(adCheckInterval);
                            adCheckInterval = null;
                            
                            // í˜„ì¬ ê³¡ ìœ ì§€í•˜ê³  ë‹¤ì‹œ ì¬ìƒ ì‹œë„
                            setTimeout(() => {
                                playNextAutoSong();
                            }, 1000);
                        }
                    } catch (e) {
                        // getVideoUrl() í˜¸ì¶œ ì‹¤íŒ¨ ì‹œ ë¬´ì‹œ
                    }
                }, 2000); // 2ì´ˆë§ˆë‹¤ ì²´í¬
            }
            // YT.PlayerState.PAUSED = 2 (ì¼ì‹œì •ì§€)
            else if (event.data === YT.PlayerState.PAUSED) {
                if (adCheckInterval) {
                    clearInterval(adCheckInterval);
                    adCheckInterval = null;
                }
            }
        }

        // Player ì—ëŸ¬ ì²˜ë¦¬
        function onPlayerError(event) {
            console.error('âŒ YouTube Player ì—ëŸ¬:', event.data);
            const currentSong = autoPlayQueue[0];
            if (currentSong) {
                currentSong.failed = true;
                currentSong.failReason = 'ì¬ìƒ ë¶ˆê°€ (YouTube ì—ëŸ¬)';
                updateAutoPlayQueue();
                
                // ë‹¤ìŒ ê³¡ìœ¼ë¡œ
                setTimeout(() => {
                    autoPlayQueue.shift();
                    updateAutoPlayQueue();
                    playNextAutoSong();
                }, 1000);
            }
        }

        // ë‹¤ìŒ ê³¡ ìë™ ì¬ìƒ
        async function playNextAutoSong() {
            if (autoPlayQueue.length === 0) {
                document.getElementById('nowPlaying').style.display = 'none';
                if (youtubePlayer) {
                    youtubePlayer.stopVideo();
                }
                return;
            }
            
            const currentSong = autoPlayQueue[0];
            
            // ë¶€ì¬ì ìë™ íŒ¨ìŠ¤ ì²´í¬ (AI ì¶”ì²œ, ìŠ¤íŠ¸ë¦¬ë¨¸ ì§ì ‘ ë“±ë¡ ì œì™¸)
            if (autoSkipAbsentSetting && 
                currentSong.requester !== 'AI ì¶”ì²œ' && 
                !currentSong.isStreamer &&
                !currentViewers.has(currentSong.requester)) {
                console.log('â­ï¸ ë¶€ì¬ì ìë™ íŒ¨ìŠ¤:', currentSong.requester);
                autoPlayQueue.shift();
                updateAutoPlayQueue();
                playNextAutoSong();
                return;
            }
            
            console.log('ğŸµ ì¬ìƒ ì‹œì‘:', currentSong);
            
            // í˜„ì¬ ì¬ìƒ ì¤‘ ì •ë³´ í‘œì‹œ
            document.getElementById('nowPlaying').style.display = 'block';
            document.getElementById('currentSongTitle').textContent = currentSong.title;
            document.getElementById('currentRequester').textContent = currentSong.requester;
            
            try {
                // YouTube Playerê°€ ì¤€ë¹„ë˜ì§€ ì•Šì•˜ìœ¼ë©´ ì´ˆê¸°í™”
                if (!youtubePlayer || !isPlayerReady) {
                    console.log('â³ YouTube Player ì´ˆê¸°í™” ì¤‘...');
                    initYouTubePlayer();
                    // Player ì¤€ë¹„ë  ë•Œê¹Œì§€ ëŒ€ê¸°
                    setTimeout(() => playNextAutoSong(), 1000);
                    return;
                }
                
                // YouTube IFrame Playerë¡œ ì¬ìƒ
                youtubePlayer.loadVideoById({
                    videoId: currentSong.videoId,
                    startSeconds: 0
                });
                
                console.log('âœ… YouTube Playerë¡œ ì¬ìƒ:', currentSong.videoId);
            } catch (error) {
                console.error('âŒ ì¬ìƒ ì˜¤ë¥˜:', error);
                
                // ì¬ìƒ ì‹¤íŒ¨ í‘œì‹œ
                currentSong.failed = true;
                currentSong.failReason = 'ì¬ìƒ ë¶ˆê°€ (ì‹œìŠ¤í…œ ì˜¤ë¥˜)';
                updateAutoPlayQueue();
                
                // ë‹¤ìŒ ê³¡ìœ¼ë¡œ
                setTimeout(() => {
                    autoPlayQueue.shift();
                    updateAutoPlayQueue();
                    playNextAutoSong();
                }, 1000);
            }
        }

        // CSS ì• ë‹ˆë©”ì´ì…˜ ì¶”ê°€
        const style = document.createElement('style');
        style.textContent = `
            @keyframes spin {
                to { transform: rotate(360deg); }
            }
        `;
        document.head.appendChild(style);
    </script>
    <script src="/js/timezone-detector.js"></script>
</body>
</html>
