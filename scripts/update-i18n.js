const fs = require('fs');
const path = require('path');

// locales í´ë”ì˜ JSON íŒŒì¼ë“¤ì„ ì½ì–´ì„œ i18n.js ì—…ë°ì´íŠ¸
function main() {
    console.log('ğŸ”„ Updating i18n.js from locale files...\n');

    const localesDir = path.join(__dirname, '../locales');
    const i18nPath = path.join(__dirname, '../public/js/i18n.js');

    // ëª¨ë“  ì–¸ì–´ íŒŒì¼ ì½ê¸°
    const languages = ['en', 'ko', 'ja', 'es', 'zh-TW', 'vi'];
    const translations = {};

    for (const lang of languages) {
        const filePath = path.join(localesDir, `${lang}.json`);
        if (fs.existsSync(filePath)) {
            translations[lang] = JSON.parse(fs.readFileSync(filePath, 'utf8'));
            console.log(`âœ… Loaded ${lang}.json`);
        } else {
            console.warn(`âš ï¸  ${lang}.json not found, skipping...`);
        }
    }

    // i18n.js íŒŒì¼ ìƒì„±
    let i18nContent = `// Auto-generated by update-i18n.js
// To update translations: 
// 1. Edit files in /locales folder
// 2. Run: npm run update-i18n

const translations = ${JSON.stringify(translations, null, 4).replace(/"([^"]+)":/g, '$1:')};

// í˜„ì¬ ì–¸ì–´ (ê¸°ë³¸ê°’: ì˜ì–´)
let currentLang = localStorage.getItem('tikfind_lang') || 'en';

// ë¸Œë¼ìš°ì € ì–¸ì–´ ìë™ ê°ì§€
function detectBrowserLanguage() {
    const browserLang = navigator.language || navigator.userLanguage;
    
    if (browserLang.startsWith('ko')) return 'ko';
    if (browserLang.startsWith('ja')) return 'ja';
    if (browserLang.startsWith('es')) return 'es';
    if (browserLang.startsWith('zh')) return 'zh-TW';
    if (browserLang.startsWith('vi')) return 'vi';
    
    return 'en';
}

// IP ê¸°ë°˜ êµ­ê°€ ê°ì§€ (ì„ íƒì‚¬í•­)
async function detectCountryByIP() {
    try {
        const response = await fetch('https://ipapi.co/json/');
        const data = await response.json();
        const countryCode = data.country_code;
        
        // êµ­ê°€ ì½”ë“œë¥¼ ì–¸ì–´ ì½”ë“œë¡œ ë§¤í•‘
        const countryToLang = {
            'KR': 'ko',
            'JP': 'ja',
            'ES': 'es',
            'MX': 'es',
            'AR': 'es',
            'TW': 'zh-TW',
            'HK': 'zh-TW',
            'VN': 'vi'
        };
        
        return countryToLang[countryCode] || 'en';
    } catch (error) {
        console.log('IP detection failed, using browser language');
        return detectBrowserLanguage();
    }
}

// ì–¸ì–´ ì´ˆê¸°í™” (IP ê¸°ë°˜ ìš°ì„ , ê·¸ ë‹¤ìŒ ë¸Œë¼ìš°ì € ì–¸ì–´)
if (!localStorage.getItem('tikfind_lang')) {
    detectCountryByIP().then(lang => {
        currentLang = lang;
        localStorage.setItem('tikfind_lang', lang);
        applyTranslations();
    });
} else {
    currentLang = localStorage.getItem('tikfind_lang');
}

// ë²ˆì—­ í•¨ìˆ˜
function t(key) {
    return translations[currentLang]?.[key] || translations['en']?.[key] || key;
}

// ì–¸ì–´ ë³€ê²½
function changeLanguage(lang) {
    if (translations[lang]) {
        currentLang = lang;
        localStorage.setItem('tikfind_lang', lang);
        location.reload();
    }
}

// ë²ˆì—­ ì ìš©
function applyTranslations() {
    document.querySelectorAll('[data-i18n]').forEach(element => {
        const key = element.getAttribute('data-i18n');
        element.textContent = t(key);
    });
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ë²ˆì—­ ì ìš©
document.addEventListener('DOMContentLoaded', function() {
    applyTranslations();
    createLanguageSelector();
});

// ì–¸ì–´ ì„ íƒ ë“œë¡­ë‹¤ìš´ ìƒì„±
function createLanguageSelector() {
    const langSelector = document.getElementById('language-selector');
    if (!langSelector) return;
    
    const languages = {
        'en': 'English',
        'ko': 'í•œêµ­ì–´',
        'ja': 'æ—¥æœ¬èª',
        'es': 'EspaÃ±ol',
        'zh-TW': 'ç¹é«”ä¸­æ–‡',
        'vi': 'Tiáº¿ng Viá»‡t'
    };
    
    let html = '<select id="lang-dropdown" class="px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 bg-white">';
    
    for (const [code, name] of Object.entries(languages)) {
        const selected = code === currentLang ? 'selected' : '';
        html += \`<option value="\${code}" \${selected}>\${name}</option>\`;
    }
    
    html += '</select>';
    langSelector.innerHTML = html;
    
    document.getElementById('lang-dropdown').addEventListener('change', function(e) {
        changeLanguage(e.target.value);
    });
}

// Export for use in other scripts
window.TikFindI18n = {
    t,
    changeLanguage,
    currentLang: () => currentLang
};
`;

    fs.writeFileSync(i18nPath, i18nContent, 'utf8');
    console.log('\nâœ… i18n.js updated successfully!');
    console.log('ğŸ“ Location: public/js/i18n.js\n');
}

main();
